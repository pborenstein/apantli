{# Macro for date filter UI component #}
{% macro date_filter() %}
<div class="date-filter">
    <div class="filter-buttons">
        <button class="filter-btn" :class="{ 'active': isQuickActive(dateFilter, 'all') }" @click="setQuickFilter(dateFilter, 'all')">All Time</button>
        <button class="filter-btn" :class="{ 'active': isQuickActive(dateFilter, 'today') }" @click="setQuickFilter(dateFilter, 'today')">Today</button>
        <button class="filter-btn" :class="{ 'active': isQuickActive(dateFilter, 'yesterday') }" @click="setQuickFilter(dateFilter, 'yesterday')">Yesterday</button>
        <button class="filter-btn" :class="{ 'active': isQuickActive(dateFilter, 'this-week') }" @click="setQuickFilter(dateFilter, 'this-week')">This Week</button>
        <button class="filter-btn" :class="{ 'active': isQuickActive(dateFilter, 'this-month') }" @click="setQuickFilter(dateFilter, 'this-month')">This Month</button>
        <button class="filter-btn" :class="{ 'active': isQuickActive(dateFilter, 'last-30-days') }" @click="setQuickFilter(dateFilter, 'last-30-days')">Last 30 Days</button>
    </div>

    <div class="filter-custom">
        <input type="date" x-model="dateFilter.startDate">
        <span>to</span>
        <input type="date" x-model="dateFilter.endDate">
        <button @click="dateFilter = { startDate: '', endDate: '' }" class="btn btn-secondary">Clear Filter</button>
    </div>
    <div class="filter-active-text" x-show="dateFilter.startDate || dateFilter.endDate">
        Active filter: <span x-text="dateFilter.startDate || '(none)'"></span> to <span x-text="dateFilter.endDate || '(none)'"></span>
    </div>
</div>
{% endmacro %}

<!DOCTYPE html>
<html>
<head>
    <title>apantli ≈ dashboard</title>
    <link rel="icon" href="/static/favicon.ico" sizes="32x32">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <script>
        // Version marker to help debug caching issues
        window.APANTLI_VERSION = '2025-10-16-001';
    </script>
    <script defer src="/static/alpine-persist.min.js"></script>
    <script defer src="/static/alpine.min.js"></script>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body x-data="{
    currentTab: $persist('stats'),
    theme: $persist('light'),
    showSettings: false,
    selectedFont: $persist('system'),
    fontSize: $persist('normal'),
    fontWeight: $persist('normal'),
    fontOptions: [
        { id: 'system', name: 'System Default', mono: 'SF Mono, Monaco, Cascadia Code, Roboto Mono, monospace', sans: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' },
        { id: 'roboto-mono', name: 'Roboto Mono (Thin)', mono: 'Roboto Mono, monospace', sans: 'Roboto, sans-serif', cdnUrl: 'https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@200;300;400;500&family=Roboto:wght@300;400;500&display=swap' },
        { id: 'inconsolata', name: 'Inconsolata (Light)', mono: 'Inconsolata, monospace', sans: 'Inter, sans-serif', cdnUrl: 'https://fonts.googleapis.com/css2?family=Inconsolata:wght@200;300;400;500&family=Inter:wght@300;400;500&display=swap' },
        { id: 'ibm-plex', name: 'IBM Plex', mono: 'IBM Plex Mono, monospace', sans: 'IBM Plex Sans, sans-serif', cdnUrl: 'https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap' },
        { id: 'jetbrains', name: 'JetBrains Mono', mono: 'JetBrains Mono, monospace', sans: 'Inter, sans-serif', cdnUrl: 'https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Inter:wght@300;400;500;600&display=swap' },
        { id: 'fira', name: 'Fira Code', mono: 'Fira Code, monospace', sans: 'Fira Sans, sans-serif', cdnUrl: 'https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600&family=Fira+Sans:wght@300;400;500;600&display=swap' },
        { id: 'source', name: 'Source Code Pro', mono: 'Source Code Pro, monospace', sans: 'Source Sans 3, sans-serif', cdnUrl: 'https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;500;600&display=swap' }
    ],
    fontSizeOptions: [
        { id: 'compact', name: 'Compact', size: '13px' },
        { id: 'normal', name: 'Normal', size: '15px' },
        { id: 'large', name: 'Large', size: '17px' },
        { id: 'extra-large', name: 'Extra Large', size: '19px' }
    ],
    fontWeightOptions: [
        { id: 'extra-light', name: 'Extra Light', weight: '200' },
        { id: 'light', name: 'Light', weight: '300' },
        { id: 'normal', name: 'Normal', weight: '400' },
        { id: 'medium', name: 'Medium', weight: '500' },
        { id: 'semibold', name: 'Semibold', weight: '600' }
    ],
    dateFilter: $persist({
        startDate: '',
        endDate: ''
    }),
    dbDateRange: { startDate: null, endDate: null },
    currentPage: 1,
    itemsPerPage: 50,
    totalItems: 0,
    requestFilters: $persist({
        provider: '',
        model: '',
        minCost: '',
        maxCost: '',
        search: ''
    }),

    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', this.theme);
    },

    formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },

    // Set filter to quick range
    async setQuickFilter(filter, range) {
        const today = new Date();

        switch(range) {
            case 'all':
                // Clear filter to show all requests
                filter.startDate = '';
                filter.endDate = '';
                // Still fetch DB range for display purposes
                try {
                    const res = await fetch('/stats/date-range');
                    const data = await res.json();
                    if (data.start_date && data.end_date) {
                        this.dbDateRange.startDate = data.start_date;
                        this.dbDateRange.endDate = data.end_date;
                    }
                } catch (e) {
                    // Ignore errors
                }
                break;
            case 'today':
                filter.startDate = filter.endDate = this.formatDate(today);
                break;
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                filter.startDate = filter.endDate = this.formatDate(yesterday);
                break;
            case 'this-week':
                const weekStart = new Date(today);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                filter.startDate = this.formatDate(weekStart);
                filter.endDate = this.formatDate(weekEnd);
                break;
            case 'this-month':
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                filter.startDate = this.formatDate(monthStart);
                filter.endDate = this.formatDate(monthEnd);
                break;
            case 'last-30-days':
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filter.startDate = this.formatDate(thirtyDaysAgo);
                filter.endDate = this.formatDate(today);
                break;
        }
    },

    // Check if filter matches a quick range
    isQuickActive(filter, range) {
        if (range === 'all') {
            // Check if it matches the database range or is empty
            return (!filter.startDate && !filter.endDate) ||
                   (this.dbDateRange.startDate &&
                    filter.startDate === this.dbDateRange.startDate &&
                    filter.endDate === this.dbDateRange.endDate);
        }

        const temp = { startDate: '', endDate: '' };
        this.setQuickFilter(temp, range);
        return filter.startDate === temp.startDate && filter.endDate === temp.endDate;
    },

    // Build query string from filter
    buildQuery(filter) {
        const timezoneOffset = -new Date().getTimezoneOffset();
        let query = `?timezone_offset=${timezoneOffset}`;

        if (filter.startDate && filter.endDate) {
            query += `&start_date=${filter.startDate}&end_date=${filter.endDate}`;
        }
        return query;
    }
}" x-init="
    // Set initial theme
    document.documentElement.setAttribute('data-theme', theme);

    // Apply persisted font settings on page load
    let debug = 'selectedFont: ' + selectedFont + '<br>fontSize: ' + fontSize + '<br>fontWeight: ' + fontWeight + '<br><br>';

    const font = fontOptions.find(f => f.id === selectedFont);
    debug += 'font found: ' + (font ? font.name : 'NO') + '<br>';
    if (font) {
        if (font.cdnUrl && !document.getElementById('font-' + selectedFont)) {
            const link = document.createElement('link');
            link.id = 'font-' + selectedFont;
            link.rel = 'stylesheet';
            link.href = font.cdnUrl;
            document.head.appendChild(link);
            debug += 'CDN loaded<br>';
        }
        document.documentElement.style.setProperty('--font-mono', font.mono);
        document.documentElement.style.setProperty('--font-system', font.sans);
        debug += 'Set --font-mono<br>';
    }

    const sizeOption = fontSizeOptions.find(s => s.id === fontSize);
    debug += 'size found: ' + (sizeOption ? sizeOption.size : 'NO') + '<br>';
    if (sizeOption) {
        document.documentElement.style.setProperty('--font-size-base', sizeOption.size);
        debug += 'Set --font-size-base to ' + sizeOption.size + '<br>';
    }

    const weightOption = fontWeightOptions.find(w => w.id === fontWeight);
    debug += 'weight found: ' + (weightOption ? weightOption.weight : 'NO') + '<br>';
    if (weightOption) {
        document.documentElement.style.setProperty('--font-weight-base', weightOption.weight);
        debug += 'Set --font-weight-base to ' + weightOption.weight + '<br>';
    }

    // Check what the body element actually has
    setTimeout(() => {
        const bodyStyle = getComputedStyle(document.body);
        debug += '<br><strong>Body computed style:</strong><br>';
        debug += 'font-size: ' + bodyStyle.fontSize + '<br>';
        debug += 'font-weight: ' + bodyStyle.fontWeight + '<br>';
        debug += 'font-family: ' + bodyStyle.fontFamily.substring(0, 30) + '...<br>';

        const debugEl = document.getElementById('debug-info');
        if (debugEl) debugEl.innerHTML = debug;
    }, 100);

    // Initialize tab from URL hash if present
    const initialHash = window.location.hash.slice(1);
    if (initialHash && ['stats', 'calendar', 'models', 'requests'].includes(initialHash)) {
        currentTab = initialHash;
    }

    // Watch currentTab and update URL hash (for browser history)
    $watch('currentTab', value => {
        onTabChange(value);
        // Update hash without triggering hashchange event (prevents loop)
        if (window.location.hash.slice(1) !== value) {
            window.history.pushState(null, '', '#' + value);
        }
    });

    $watch('theme', value => {
        // Reload calendar when theme changes to update colors
        if (currentTab === 'calendar') {
            loadCalendar();
        }
    });

    // Watch font settings and apply when they change (including on initial load from $persist)
    $watch('selectedFont', value => {
        const font = fontOptions.find(f => f.id === value);
        if (!font) return;

        // Load font from CDN if needed
        if (font.cdnUrl && !document.getElementById('font-' + value)) {
            const link = document.createElement('link');
            link.id = 'font-' + value;
            link.rel = 'stylesheet';
            link.href = font.cdnUrl;
            document.head.appendChild(link);
        }

        // Apply font to CSS variables
        document.documentElement.style.setProperty('--font-mono', font.mono);
        document.documentElement.style.setProperty('--font-system', font.sans);
    });

    $watch('fontSize', value => {
        const sizeOption = fontSizeOptions.find(s => s.id === value);
        if (sizeOption) {
            document.documentElement.style.setProperty('--font-size-base', sizeOption.size);
        }
    });

    $watch('fontWeight', value => {
        const weightOption = fontWeightOptions.find(w => w.id === value);
        if (weightOption) {
            document.documentElement.style.setProperty('--font-weight-base', weightOption.weight);
        }
    });

    $watch('dateFilter', value => {
        refreshStats();
        loadCalendar(); // Reload calendar with new filter
        if (currentPage === 1) {
            loadRequests(); // Already on page 1, manually trigger reload
        } else {
            currentPage = 1; // Will trigger loadRequests via currentPage watcher
        }
    }, { deep: true });
    $watch('requestFilters', value => {
        if (currentPage === 1) {
            loadRequests(); // Already on page 1, manually trigger reload
        } else {
            currentPage = 1; // Will trigger loadRequests via currentPage watcher
        }
    }, { deep: true });
    $watch('currentPage', value => loadRequests());
">
    <!-- Settings Modal -->
    <div class="settings-modal"
         :class="{ 'active': showSettings }"
         @click.self="showSettings = false">
        <div class="settings-content">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="settings-close" @click="showSettings = false" aria-label="Close settings">×</button>
            </div>
            <div class="settings-group">
                <label for="setting-font">Font Family</label>
                <select id="setting-font" x-model="selectedFont">
                    <template x-for="font in fontOptions" :key="font.id">
                        <option :value="font.id" x-text="font.name" :selected="font.id === selectedFont"></option>
                    </template>
                </select>
            </div>
            <div class="settings-group">
                <label for="setting-size">Font Size</label>
                <select id="setting-size" x-model="fontSize">
                    <template x-for="size in fontSizeOptions" :key="size.id">
                        <option :value="size.id" x-text="size.name" :selected="size.id === fontSize"></option>
                    </template>
                </select>
            </div>
            <div class="settings-group">
                <label for="setting-weight">Font Weight</label>
                <select id="setting-weight" x-model="fontWeight">
                    <template x-for="weight in fontWeightOptions" :key="weight.id">
                        <option :value="weight.id" x-text="weight.name" :selected="weight.id === fontWeight"></option>
                    </template>
                </select>
            </div>
        </div>
    </div>

    <header class="page-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">apantli ≈ dashboard</h1>
                <nav class="header-nav">
                    <a href="#stats" :class="{ 'active': currentTab === 'stats' }" @click.prevent="currentTab = 'stats'">Stats</a>
                    <a href="#calendar" :class="{ 'active': currentTab === 'calendar' }" @click.prevent="currentTab = 'calendar'">Calendar</a>
                    <a href="#models" :class="{ 'active': currentTab === 'models' }" @click.prevent="currentTab = 'models'">Models</a>
                    <a href="#requests" :class="{ 'active': currentTab === 'requests' }" @click.prevent="currentTab = 'requests'">Requests</a>
                </nav>
            </div>
            <div class="header-actions">
                <a href="/compare" class="btn btn-secondary">Playground</a>
                <button class="btn btn-secondary btn-icon" @click="toggleTheme()" :aria-label="theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode'">
                    <span x-show="theme === 'light'">☀</span>
                    <span x-show="theme === 'dark'">☾</span>
                </button>
                <button class="btn btn-secondary btn-icon" @click="showSettings = !showSettings" aria-label="Open settings">⚙</button>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div id="error-banner" class="error-banner" role="alert"></div>
        <div id="chart-tooltip" class="chart-tooltip"></div>

    <div id="stats-tab" x-show="currentTab === 'stats'">
        {{ date_filter() }}

        <div id="totals"></div>

        <details open>
            <summary><h2>Provider Cost Trends</h2></summary>
            <div id="provider-trends-chart"></div>
        </details>

        <details open>
            <summary><h2>Model Performance</h2></summary>
            <div>
                <h3>By Model</h3>
                <table id="by-model"></table>

                <h3>By Provider</h3>
                <table id="by-provider"></table>
            </div>
        </details>

        <details>
            <summary><h2>Errors & Debugging</h2></summary>
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                    <h3 style="margin: 0;">Recent Errors</h3>
                    <button onclick="clearErrors()" class="btn btn-secondary">Clear Errors</button>
                </div>
                <table id="errors"></table>
            </div>
        </details>
    </div>

    <div id="calendar-tab" x-show="currentTab === 'calendar'">
        {{ date_filter() }}

        <div id="calendar-container" class="calendar-container"></div>
    </div>

    <div id="models-tab" x-show="currentTab === 'models'">
        <h2>Available Models</h2>
        <div class="models-toolbar">
            <button class="btn btn-primary" onclick="openAddModelModal()">+ Add Model</button>
            <button class="btn btn-secondary" onclick="openExportModal()">Export for Obsidian</button>
        </div>
        <table id="models-list"></table>
    </div>

    <div id="requests-tab" x-show="currentTab === 'requests'">
        {{ date_filter() }}

        <div class="request-filters">
            <div class="filter-row">
                <div class="filter-search">
                    <label for="search-requests">Search:</label>
                    <input type="text" id="search-requests" placeholder="Search in model or content..." x-model="requestFilters.search">
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-select">
                    <label for="filter-provider">Provider:</label>
                    <select id="filter-provider" x-model="requestFilters.provider">
                        <option value="">All</option>
                    </select>
                </div>

                <div class="filter-select">
                    <label for="filter-model">Model:</label>
                    <select id="filter-model" x-model="requestFilters.model">
                        <option value="">All</option>
                    </select>
                </div>

                <div class="filter-cost-range">
                    <label>Cost Range:</label>
                    <input type="number" id="min-cost" placeholder="Min $" step="0.0001" min="0" x-model.number="requestFilters.minCost">
                    <span>to</span>
                    <input type="number" id="max-cost" placeholder="Max $" step="0.0001" min="0" x-model.number="requestFilters.maxCost">
                </div>
            </div>
        </div>

        <div id="request-summary" style="display: none;" class="request-summary">
            <div class="summary-metric">
                <span class="metric-value" id="summary-count">0</span>
                <span class="metric-label">Requests</span>
            </div>
            <div class="summary-metric">
                <span class="metric-value" id="summary-cost">$0.00</span>
                <span class="metric-label">Total Cost</span>
            </div>
            <div class="summary-metric">
                <span class="metric-value" id="summary-tokens">0</span>
                <span class="metric-label">Tokens</span>
            </div>
            <div class="summary-metric">
                <span class="metric-value" id="summary-avg-cost">$0.00</span>
                <span class="metric-label">Avg Cost</span>
            </div>
        </div>

        <h2>Recent Requests</h2>
        <table id="requests-list"></table>

        <div class="pagination" x-show="totalItems > itemsPerPage">
            <button @click="currentPage = Math.max(1, currentPage - 1)" :disabled="currentPage === 1">Previous</button>
            <span>Page <span x-text="currentPage"></span> of <span x-text="Math.ceil(totalItems / itemsPerPage)"></span></span>
            <button @click="currentPage = Math.min(Math.ceil(totalItems / itemsPerPage), currentPage + 1)" :disabled="currentPage >= Math.ceil(totalItems / itemsPerPage)">Next</button>
            <span style="margin-left: 20px">Showing <span x-text="Math.min(itemsPerPage, totalItems - (currentPage - 1) * itemsPerPage)"></span> of <span x-text="totalItems"></span> requests</span>
        </div>
    </div>
    </main>

    <footer style="text-align: center; padding: 0.5rem; margin-top: 1rem; border-top: 1px solid var(--border-color); font-size: 0.7rem; color: var(--text-secondary);">
        <a href="https://apantli.app" style="color: var(--text-primary); text-decoration: none;">apantli</a>
        &copy; 2025
        <a href="https://pborenstein.dev" style="color: var(--text-primary); text-decoration: none;">Philip Borenstein</a>
        /
        Made in New England
        <svg style="display: inline-block; width: 20px; height: 12px; margin-left: 4px; vertical-align: middle;" viewBox="0 0 720 432" xmlns="http://www.w3.org/2000/svg">
            <rect fill="#BF0000" width="720" height="432"/>
            <rect fill="#FFFFFF" width="216" height="216"/>
            <path fill="#8B5C29" d="M114.15,170.029c0.014,5.968-0.477,11.827-0.515,17.716c-0.014,2.087,0.094,4.623,0.532,6.655c0.371,1.723,1.579,3.449,1.61,5.309c1.604,0.192,1.417,2.074,2.89,2.24c3.276,5.972-4.25,4.03-8.133,4.017c-2.596-0.009-5.317,0.471-7.708,0.374c-2.542-0.102-4.343-0.099-6.985,0.693c0.775-0.864,1.915-1.14,2.653-2.073c1.315-1.661,0.982-3.981,1.256-5.948c0.48-3.446,0.51-6.72,0.543-10.222c0.03-3.22,0.646-6.491,1.014-9.534c0.379-3.143,0.017-6.566,0.012-9.74"/>
            <path fill="#00A33D" d="M106.451,177.728c-0.659,0.771-2.116,2.905-3.317,2.956c-0.677,0.028-0.791-0.767-1.382-0.835c-1.293-0.15-2.95-0.131-4.254-0.084c-3.118,0.112-6.175,0.19-9.288-0.195c-5.419-0.671-9.691-0.84-14.821,1.004c-2.198,0.791-4.47,0.994-6.891,0.757c-2.634-0.257-5.513-0.324-8.1-0.917c-2.044-0.468-5.359-1.641-3.124-4.239c2.086-2.422,5.909-0.999,7.908-2.977c-5.916-0.576-11.514,1.969-17.245,1.207c-2.225-0.295-6.479-0.411-4.526-3.638c1.237-2.043,4.039-3.845,4.58-6.283c1.443-0.231,2.658-2.697,3.968-3.55c1.415-0.921,3.485-1.811,5.079-2.284c0.805-2.183-1.333-2.853-1.97-4.477c-0.942-2.404,1.583-3.115,2.159-5.085c0.276-0.067,0.552-0.133,0.829-0.197c0.064-0.276,0.129-0.554,0.196-0.83c0.945-0.081,2.306-1.621,2.98-2.273c0.959-0.927,3.269-2.896,3.555-3.886c-3.207,0.052-0.782-3.19,0.211-4.096c1.622-1.482,3.088-2.2,4.813-3.332c1.044-0.686,3.19-2.747,2.736-4.204c-0.56-1.798-3.338-1.085-4.04-2.892c-1.123-2.891,3.778-7.663,5.296-10.006c1.02-1.576,2.386-2.687,3.733-3.944c1.773-1.655,2.878-3.862,4.573-5.562c-3.283,0.325-6.411-0.641-9.504-0.528c-1.313-3.878,6.129-7.486,8.178-9.531c1.532-1.53,2.78-3.687,4.41-5.291c1.409-1.387,3.391-4.042,5.114-4.628c-2.75-0.049-5.117,2.07-7.951,1.488c-0.66-2.025,3.381-6.556,4.343-8.393c1.374-2.622,4.216-5.47,4.853-8.503c1.038-4.941-3.487-2.807-4.999-5.742c-1.485-2.881,4.017-4.102,4.961-5.451c0.809-1.155,0.862-3.811,0.021-4.947c-0.834-1.126-2.029-0.736-2.104-2.371c-0.132-2.932,3.591-5.725,4.49-8.142c0.585-1.572-0.176-3.076-0.337-4.579c-0.174-1.611,0.401-3.653,1.082-5.035c0.461-0.936,1.487-1.887,1.98-3.054c0.356-0.846,0.654-1.671,1.024-2.52c0.759-1.744,1.573-3.308,2.331-5.197c0.955-2.379,3.654-3.548,4.824-5.754c0.821-1.548,0.292-3.377,1.16-4.991c0.654-1.212,1.341-1.934,1.723-3.256c-0.185-0.106-0.278-0.277-0.284-0.515l4.106-3.592c0.703,1.062,0.862,2.783,1.405,3.979c0.49,1.08,0.988,2.156,1.548,3.204c0.768,1.439,1.522,2.849,2.084,4.2c1.38,3.323,2.236,6.437,3.909,9.645c0.758,1.453,1.75,2.673,2.355,4.079c0.779,1.809,0.788,3.547,1.253,5.419c0.43,1.733,1.391,3.207,1.798,4.881c0.417,1.71,2.248,4.455,2.006,6.087c-0.787,0.03-1.67,0.012-2.447,0.181c1.553,3.237,5.245,5.556,7.414,8.364c1.064,1.38,1.237,2.384,1.79,3.822c0.419,1.092,1.137,2.117,1.003,3.32c-0.06,0.541-0.567,1.026-0.594,1.754c-0.285,0.056-0.569,0.113-0.853,0.173c-0.58,1.76,0.959,3.569,1.704,5.048c1.098,2.178,0.684,2.021-0.389,4.066c-1.116,2.13-0.914,3.538-0.366,5.683c0.306,1.2,0.131,1.724,1.006,2.83c0.613,0.774,1.451,1.217,1.646,2.202c0.275,0.072,0.553,0.134,0.833,0.189c0.268,1.856,3.144,3.968,2.693,6.083c-0.533,2.495-3.82,1.715-0.563,4.817c2.303,2.195,8.194,5.46,7.652,9.463c-2.047,0.115-3.539,1.29-5.513,1.193c0.25,1.777,3.247,2.755,4.385,4.131c1.618,1.956,2.957,4.649,5.307,5.831c2.662,1.338,11.009,4.133,4.625,7.38c-1.801,0.915-10.238,0.596-9.015,3.635c1.022,2.539,5.035,1.692,1.314,4.172c-2.718,1.812-4.869,1.769-8.094,2.18c0.958,1.79,4.134,4.129,5.709,4.846c1.166,0.532,2.744,0.302,4.004,0.662c3.18,0.906,5.853,2.899,8.916,4.088c2.311,0.897,4.728,1.903,6.799,2.995c1.963,1.036,3.902,3.257,5.921,4.206c-2.742,1.363-8.363,3.684-11.745,3.556c-1.226-0.047-1.769-0.463-3.103-0.333c-1.995,0.195-3.461,0.956-5.506,0.78c3.402,1.388,8.062,0.741,10.97,3.062c2.256,1.8,2.247,4.787,5.378,5.921c2.095,0.758,4.279,0.754,6.477,1.388c1.771,0.512,3.354,0.634,5.062,1.057c1.856,0.458,1.959,1.229,2.508,2.864c-0.933,0.627-2.056,0.844-3.046,1.4c-1.701,0.958-2.596,2.857-4.1,3.766c-2.162,1.306-6.182,2.48-8.712,2.148c-3.652-0.479-6.491,0.374-10.233,0.496c-2.258,0.075-4.304,1.029-6.563,1.107c1.459,1.327,2.812,2.674,4.452,3.811c1.666,1.155,3.636,1.812,5.079,3.412c-0.984,2.847-8.668,1.344-10.879,0.849c-1.995-0.448-3.829-0.442-5.926-0.451c-3.283-0.015-5.539-0.708-8.729-1.309c-9.681-1.825-16.693-10.305-27.197-8.89c-0.019,0.789,0.374,1.167,0.973,1.464L106.451,177.728z"/>
        </svg>
    </footer>

    <!-- Export Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Export for Obsidian Copilot</h3>
                <button class="modal-close" onclick="closeExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Copy this JSON configuration and paste it into Obsidian Copilot settings:</p>
                <div class="export-info">
                    <strong>Models exported:</strong> <span id="export-count">0</span> (enabled models only)
                </div>
                <pre id="export-json" class="json-preview"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="copyExportJson()">Copy to Clipboard</button>
                <button class="btn btn-secondary" onclick="closeExportModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Model Wizard Modal -->
    <div id="add-model-modal" class="modal">
        <div class="modal-content modal-wizard">
            <div class="modal-header">
                <h3>Add New Model</h3>
                <button class="modal-close" onclick="closeAddModelModal()">&times;</button>
            </div>
            <div class="wizard-progress">
                <div class="wizard-step" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Provider</div>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Model</div>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Configure</div>
                </div>
            </div>
            <div class="modal-body">
                <!-- Step 1: Select Provider -->
                <div id="wizard-step-1" class="wizard-content">
                    <h4>Select Provider</h4>
                    <div class="provider-search">
                        <input type="text" id="provider-search" placeholder="Search providers..." />
                    </div>
                    <div id="provider-list" class="provider-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Step 2: Select Model -->
                <div id="wizard-step-2" class="wizard-content" style="display: none;">
                    <h4>
                        Select Model from <span id="selected-provider-name"></span>
                        <a href="#" id="provider-docs-link" target="_blank" class="provider-docs-link" title="View provider documentation">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                        </a>
                    </h4>
                    <div class="model-controls">
                        <div class="model-search">
                            <input type="text" id="model-search" placeholder="Search models..." />
                        </div>
                        <div class="model-sort">
                            <label>Sort by:</label>
                            <select id="model-sort-select" onchange="sortModelList()">
                                <option value="name">Name</option>
                                <option value="input-cost">Input Cost</option>
                                <option value="output-cost">Output Cost</option>
                            </select>
                        </div>
                    </div>
                    <div id="model-list" class="model-grid">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Step 3: Configure Model -->
                <div id="wizard-step-3" class="wizard-content" style="display: none;">
                    <h4>Configure Model</h4>
                    <div class="form-section">
                        <div class="form-group">
                            <label for="model-name-input">Model Name (alias for Apantli) *</label>
                            <input type="text" id="model-name-input" placeholder="e.g., gpt4-fast" required />
                            <small>This is the name you'll use to call this model</small>
                        </div>

                        <div class="form-group">
                            <label for="api-key-env-input">API Key Environment Variable *</label>
                            <input type="text" id="api-key-env-input" placeholder="e.g., OPENAI_API_KEY" required />
                            <small>The environment variable name containing the API key</small>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="model-enabled-input" checked />
                                Enable model immediately
                            </label>
                        </div>

                        <details class="advanced-options">
                            <summary>Advanced Options (optional)</summary>
                            <div class="form-group">
                                <label for="temperature-input">Temperature</label>
                                <input type="number" id="temperature-input" min="0" max="2" step="0.1" placeholder="0.7" />
                                <small>Controls randomness (0.0 - 2.0)</small>
                            </div>

                            <div class="form-group">
                                <label for="max-tokens-input">Max Tokens</label>
                                <input type="number" id="max-tokens-input" min="1" placeholder="4096" />
                                <small>Maximum tokens in response</small>
                            </div>

                            <div class="form-group">
                                <label for="timeout-input">Timeout (seconds)</label>
                                <input type="number" id="timeout-input" min="1" placeholder="120" />
                                <small>Request timeout in seconds</small>
                            </div>

                            <div class="form-group">
                                <label for="retries-input">Number of Retries</label>
                                <input type="number" id="retries-input" min="0" max="10" placeholder="2" />
                                <small>Retry attempts on failure</small>
                            </div>
                        </details>

                        <div class="model-info-summary">
                            <h5>Selected Model Details</h5>
                            <div class="info-row">
                                <span class="info-label">LiteLLM Model ID:</span>
                                <span id="summary-litellm-model"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Input Cost:</span>
                                <span id="summary-input-cost"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Output Cost:</span>
                                <span id="summary-output-cost"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Max Tokens:</span>
                                <span id="summary-max-tokens"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer wizard-footer">
                <button class="btn btn-secondary" id="wizard-back-btn" onclick="wizardBack()" style="display: none;">Back</button>
                <button class="btn btn-secondary" onclick="closeAddModelModal()">Cancel</button>
                <button class="btn btn-primary" id="wizard-next-btn" onclick="wizardNext()" disabled>Next</button>
                <button class="btn btn-primary" id="wizard-submit-btn" onclick="submitAddModel()" style="display: none;">Add Model</button>
            </div>
        </div>
    </div>

    <script src="/static/js/dashboard.js?v=20251124-1"></script>
</body>
</html>
