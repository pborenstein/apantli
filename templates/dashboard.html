<!DOCTYPE html>
<html>
<head>
    <title>LLM Proxy Stats</title>
    <style>
        body { font-family: monospace; max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        h1 { border-bottom: 2px solid #333; }
        h2 { margin-top: 30px; border-bottom: 1px solid #666; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background: #f0f0f0; }
        .metric { display: inline-block; margin: 10px 20px 10px 0; }
        .metric-value { font-size: 24px; font-weight: bold; }
        .metric-label { font-size: 12px; color: #666; }
        .error { color: #c00; }
        .request-row { cursor: pointer; }
        .request-row:hover { background: #f5f5f5; }
        .request-detail { padding: 10px; background: #f9f9f9; }
        .json-view { font-size: 11px; overflow-x: auto; margin: 5px 0; }
        .json-tree { font-family: monospace; line-height: 1.4; }
        .json-key { color: #881391; }
        .json-string { color: #1A1AA6; }
        .json-number { color: #1C00CF; }
        .json-boolean { color: #0D22AA; }
        .json-null { color: #808080; }
        .json-toggle { cursor: pointer; user-select: none; display: inline-block; width: 12px; }
        .json-toggle:hover { background: #e0e0e0; }
        .json-line { margin-left: 20px; }
        .json-collapsed { display: none; }
        nav { margin: 20px 0; border-bottom: 1px solid #ccc; }
        nav a { display: inline-block; padding: 10px 20px; text-decoration: none; color: #333; }
        nav a.active { border-bottom: 2px solid #333; font-weight: bold; }
    </style>
</head>
<body>
    <h1>LLM Proxy Statistics</h1>

    <nav>
        <a href="#" class="active" onclick="showTab(event, 'stats')">Stats</a>
        <a href="#" onclick="showTab(event, 'models')">Models</a>
        <a href="#" onclick="showTab(event, 'requests')">Requests</a>
    </nav>

    <div id="stats-tab">
        <div style="margin: 20px 0;">
            Time range:
            <select id="timeRange" onchange="refresh()">
                <option value="">All time</option>
                <option value="1">Last hour</option>
                <option value="4">Last 4 hours</option>
                <option value="6">Last 6 hours</option>
                <option value="12">Last 12 hours</option>
                <option value="24">Last 24 hours</option>
                <option value="168">Last week</option>
                <option value="720">Last 30 days</option>
            </select>
        </div>

        <div id="totals"></div>

        <h2>By Model</h2>
        <table id="by-model"></table>

        <h2>By Provider</h2>
        <table id="by-provider"></table>

        <h2>Recent Errors <button onclick="clearErrors()" style="margin-left: 10px;">Clear Errors</button></h2>
        <table id="errors"></table>
    </div>

    <div id="models-tab" style="display:none">
        <h2>Available Models</h2>
        <table id="models-list"></table>
    </div>

    <div id="requests-tab" style="display:none">
        <div style="margin: 20px 0;">
            Time range:
            <select id="requestsTimeRange" onchange="loadRequests()">
                <option value="">All time</option>
                <option value="1">Last hour</option>
                <option value="4">Last 4 hours</option>
                <option value="6">Last 6 hours</option>
                <option value="12">Last 12 hours</option>
                <option value="24">Last 24 hours</option>
                <option value="168">Last week</option>
                <option value="720">Last 30 days</option>
            </select>
        </div>

        <h2>Recent Requests</h2>
        <table id="requests-list"></table>
    </div>

    <script>
        let expandedRequests = new Set();

        function showTab(e, tab) {
            e.preventDefault();
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            e.target.classList.add('active');

            document.getElementById('stats-tab').style.display = tab === 'stats' ? 'block' : 'none';
            document.getElementById('models-tab').style.display = tab === 'models' ? 'block' : 'none';
            document.getElementById('requests-tab').style.display = tab === 'requests' ? 'block' : 'none';

            if (tab === 'models') loadModels();
            if (tab === 'requests') loadRequests();
        }

        async function loadModels() {
            const res = await fetch('/models');
            const data = await res.json();

            document.getElementById('models-list').innerHTML = `
                <tr>
                    <th>Name</th>
                    <th>Provider</th>
                    <th>LiteLLM Model</th>
                    <th>Input Cost/1M</th>
                    <th>Output Cost/1M</th>
                </tr>
                ${data.models.map(m => `
                    <tr>
                        <td>${m.name}</td>
                        <td>${m.provider}</td>
                        <td>${m.litellm_model}</td>
                        <td>${m.input_cost_per_million ? '$' + m.input_cost_per_million.toFixed(2) : 'N/A'}</td>
                        <td>${m.output_cost_per_million ? '$' + m.output_cost_per_million.toFixed(2) : 'N/A'}</td>
                    </tr>
                `).join('')}
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderJsonTree(obj, isRoot = true) {
            if (obj === null) return '<span class="json-null">null</span>';
            if (obj === undefined) return '<span class="json-null">undefined</span>';

            const type = typeof obj;
            if (type === 'string') return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
            if (type === 'number') return `<span class="json-number">${obj}</span>`;
            if (type === 'boolean') return `<span class="json-boolean">${obj}</span>`;

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '<span>[]</span>';

                const id = 'json-' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span>[`;
                html += `<div id="${id}" class="json-line">`;
                obj.forEach((item, i) => {
                    html += renderJsonTree(item, false);
                    if (i < obj.length - 1) html += ',';
                    html += '<br>';
                });
                html += '</div>]';
                return html;
            }

            if (type === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '<span>{}</span>';

                const id = 'json-' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span>{`;
                html += `<div id="${id}" class="json-line">`;
                keys.forEach((key, i) => {
                    html += `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                    html += renderJsonTree(obj[key], false);
                    if (i < keys.length - 1) html += ',';
                    html += '<br>';
                });
                html += '</div>}';
                return html;
            }

            return String(obj);
        }

        function toggleJson(id) {
            const el = document.getElementById(id);
            const toggle = el.previousElementSibling;
            if (el.classList.contains('json-collapsed')) {
                el.classList.remove('json-collapsed');
                toggle.textContent = '▼';
            } else {
                el.classList.add('json-collapsed');
                toggle.textContent = '▶';
            }
        }

        async function loadRequests() {
            try {
                const hours = document.getElementById('requestsTimeRange')?.value;
                const url = hours ? `/requests?hours=${hours}` : '/requests';
                const res = await fetch(url);
                const data = await res.json();

                const tbody = document.createElement('tbody');

                data.requests.forEach((r, i) => {
                    let requestHtml = '<span class="error">Error parsing request</span>';
                    let responseHtml = '<span class="error">Error parsing response</span>';

                    try {
                        const requestObj = JSON.parse(r.request_data);
                        requestHtml = renderJsonTree(requestObj);
                    } catch(e) {}

                    try {
                        const responseObj = JSON.parse(r.response_data);
                        responseHtml = renderJsonTree(responseObj);
                    } catch(e) {}

                    // Use timestamp as unique identifier
                    const requestId = r.timestamp;

                    // Create main row
                    const mainRow = document.createElement('tr');
                    mainRow.className = 'request-row';
                    mainRow.onclick = () => toggleDetail(requestId);
                    mainRow.innerHTML = `
                        <td>${escapeHtml(new Date(r.timestamp + 'Z').toLocaleString())}</td>
                        <td>${escapeHtml(r.model)}</td>
                        <td>${r.total_tokens}</td>
                        <td>$${r.cost.toFixed(4)}</td>
                        <td>${r.duration_ms}ms</td>
                    `;

                    // Create detail row, restore expanded state if it was previously expanded
                    const detailRow = document.createElement('tr');
                    detailRow.id = 'detail-' + requestId;
                    detailRow.style.display = expandedRequests.has(requestId) ? 'table-row' : 'none';
                    detailRow.innerHTML = `
                        <td colspan="5" class="request-detail">
                            <b>Request:</b>
                            <div class="json-view json-tree">${requestHtml}</div>
                            <b>Response:</b>
                            <div class="json-view json-tree">${responseHtml}</div>
                        </td>
                    `;

                    tbody.appendChild(mainRow);
                    tbody.appendChild(detailRow);
                });

                document.getElementById('requests-list').innerHTML = `
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Model</th>
                            <th>Tokens</th>
                            <th>Cost</th>
                            <th>Duration</th>
                        </tr>
                    </thead>
                `;
                document.getElementById('requests-list').appendChild(tbody);
            } catch(e) {
                document.getElementById('requests-list').innerHTML = '<tr><td colspan="5">Error loading requests</td></tr>';
            }
        }

        function toggleDetail(id) {
            const row = document.getElementById('detail-' + id);
            if (row) {
                const isHidden = row.style.display === 'none' || !row.style.display;
                row.style.display = isHidden ? 'table-row' : 'none';

                // Track expanded state
                if (isHidden) {
                    expandedRequests.add(id);
                } else {
                    expandedRequests.delete(id);
                }
            }
        }

        async function refresh() {
            const hours = document.getElementById('timeRange')?.value;
            const url = hours ? `/stats?hours=${hours}` : '/stats';
            const res = await fetch(url);
            const data = await res.json();

            // Totals
            document.getElementById('totals').innerHTML = `
                <div class="metric">
                    <div class="metric-value">${data.totals.requests}</div>
                    <div class="metric-label">REQUESTS</div>
                </div>
                <div class="metric">
                    <div class="metric-value">$${data.totals.cost.toFixed(4)}</div>
                    <div class="metric-label">TOTAL COST</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(data.totals.prompt_tokens + data.totals.completion_tokens).toLocaleString()}</div>
                    <div class="metric-label">TOTAL TOKENS</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.totals.avg_duration_ms.toFixed(0)}ms</div>
                    <div class="metric-label">AVG DURATION</div>
                </div>
            `;

            // By model
            document.getElementById('by-model').innerHTML = `
                <tr><th>Model</th><th>Requests</th><th>Cost</th><th>Tokens</th></tr>
                ${data.by_model.map(m => `
                    <tr>
                        <td>${m.model}</td>
                        <td>${m.requests}</td>
                        <td>$${m.cost.toFixed(4)}</td>
                        <td>${m.tokens.toLocaleString()}</td>
                    </tr>
                `).join('')}
            `;

            // By provider
            document.getElementById('by-provider').innerHTML = `
                <tr><th>Provider</th><th>Requests</th><th>Cost</th><th>Tokens</th></tr>
                ${data.by_provider.map(p => `
                    <tr>
                        <td>${p.provider}</td>
                        <td>${p.requests}</td>
                        <td>$${p.cost.toFixed(4)}</td>
                        <td>${p.tokens.toLocaleString()}</td>
                    </tr>
                `).join('')}
            `;

            // Errors
            if (data.recent_errors.length > 0) {
                document.getElementById('errors').innerHTML = `
                    <tr><th>Time</th><th>Model</th><th>Error</th></tr>
                    ${data.recent_errors.map(e => `
                        <tr>
                            <td>${new Date(e.timestamp + 'Z').toLocaleString()}</td>
                            <td>${e.model}</td>
                            <td class="error">${e.error}</td>
                        </tr>
                    `).join('')}
                `;
            } else {
                document.getElementById('errors').innerHTML = '<tr><td>No errors</td></tr>';
            }
        }

        async function clearErrors() {
            if (!confirm('Clear all errors from the database?')) return;
            await fetch('/errors', { method: 'DELETE' });
            refresh();
        }

        refresh();
        setInterval(refresh, 5000);
    </script>
</body>
</html>
