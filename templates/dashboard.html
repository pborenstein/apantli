<!DOCTYPE html>
<html>
<head>
    <title>LLM Proxy Stats</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { font-family: monospace; max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        h1 { border-bottom: 2px solid #333; }
        h2 { margin-top: 30px; border-bottom: 1px solid #666; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background: #f0f0f0; }
        .metric { display: inline-block; margin: 10px 20px 10px 0; }
        .metric-value { font-size: 24px; font-weight: bold; }
        .metric-label { font-size: 12px; color: #666; }
        .error { color: #c00; }
        .request-row { cursor: pointer; }
        .request-row:hover { background: #f5f5f5; }
        .request-detail { padding: 10px; background: #f9f9f9; }
        .json-view { font-size: 11px; overflow-x: auto; margin: 5px 0; }
        .json-tree { font-family: monospace; line-height: 1.4; }
        .json-key { color: #881391; }
        .json-string { color: #1A1AA6; }
        .json-number { color: #1C00CF; }
        .json-boolean { color: #0D22AA; }
        .json-null { color: #808080; }
        .json-toggle { cursor: pointer; user-select: none; display: inline-block; width: 12px; }
        .json-toggle:hover { background: #e0e0e0; }
        .json-line { margin-left: 20px; }
        .json-collapsed { display: none; }
        nav { margin: 20px 0; border-bottom: 1px solid #ccc; }
        nav a { display: inline-block; padding: 10px 20px; text-decoration: none; color: #333; }
        nav a.active { border-bottom: 2px solid #333; font-weight: bold; }

        /* Calendar styles */
        .calendar-header { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; }
        .calendar-header button { padding: 8px 16px; font-size: 18px; cursor: pointer; border: 1px solid #ddd; background: white; }
        .calendar-header button:hover { background: #f0f0f0; }
        .calendar-header h2 { margin: 0; min-width: 200px; text-align: center; }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin: 20px 0; }
        .calendar-day-header { padding: 10px; text-align: center; font-weight: bold; background: #f0f0f0; border: 1px solid #ddd; }
        .calendar-day {
            aspect-ratio: 1;
            padding: 8px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
        }
        .calendar-day:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .calendar-day.today { border: 2px solid #333; }
        .calendar-day.empty { background: #fafafa; cursor: default; }
        .calendar-day.empty:hover { transform: none; box-shadow: none; }
        .day-number { font-size: 14px; font-weight: bold; color: #333; }
        .day-cost { font-size: 12px; font-weight: bold; color: #333; margin: 4px 0; }
        .day-requests { font-size: 10px; color: #666; }

        #day-detail { margin-top: 30px; padding: 20px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 4px; }
        #day-detail h3 { margin-top: 0; }
        .provider-bar { margin: 15px 0; }
        .provider-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; }
        .bar-container { height: 24px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        .provider-details { font-size: 12px; color: #666; margin-top: 4px; }

        /* Date filter styles */
        .date-filter { background: #f9f9f9; padding: 15px; border-radius: 6px; margin: 20px 0; }
        .filter-buttons { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-family: monospace;
            font-size: 13px;
            transition: all 0.15s;
        }
        .filter-btn:hover { background: #f0f0f0; }
        .filter-btn.active { background: #333; color: white; border-color: #333; }
        .filter-custom { display: flex; align-items: center; gap: 8px; }
        .filter-custom input[type="date"] {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }
        .filter-custom span { color: #666; font-size: 13px; }

        /* Sortable table styles */
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: #e0e0e0; }
        th.sortable::after { content: ' ⇅'; color: #ccc; font-size: 10px; }
        th.sortable.sort-asc::after { content: ' ▲'; color: #333; }
        th.sortable.sort-desc::after { content: ' ▼'; color: #333; }
    </style>
</head>
<body x-data="{
    currentTab: $persist('stats'),
    statsFilter: $persist({
        startDate: '',
        endDate: ''
    }),
    requestsFilter: $persist({
        startDate: '',
        endDate: ''
    }),
    dbDateRange: { startDate: null, endDate: null },

    formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },

    // Set filter to quick range
    async setQuickFilter(filter, range) {
        const today = new Date();

        switch(range) {
            case 'all':
                // Fetch actual date range from database
                try {
                    const res = await fetch('/stats/date-range');
                    const data = await res.json();
                    if (data.start_date && data.end_date) {
                        this.dbDateRange.startDate = data.start_date;
                        this.dbDateRange.endDate = data.end_date;
                        filter.startDate = data.start_date;
                        filter.endDate = data.end_date;
                    } else {
                        filter.startDate = '';
                        filter.endDate = '';
                    }
                } catch (e) {
                    filter.startDate = '';
                    filter.endDate = '';
                }
                break;
            case 'today':
                filter.startDate = filter.endDate = this.formatDate(today);
                break;
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                filter.startDate = filter.endDate = this.formatDate(yesterday);
                break;
            case 'this-week':
                const weekStart = new Date(today);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                filter.startDate = this.formatDate(weekStart);
                filter.endDate = this.formatDate(weekEnd);
                break;
            case 'this-month':
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                filter.startDate = this.formatDate(monthStart);
                filter.endDate = this.formatDate(monthEnd);
                break;
            case 'last-30-days':
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filter.startDate = this.formatDate(thirtyDaysAgo);
                filter.endDate = this.formatDate(today);
                break;
        }
    },

    // Check if filter matches a quick range
    isQuickActive(filter, range) {
        if (range === 'all') {
            // Check if it matches the database range or is empty
            return (!filter.startDate && !filter.endDate) ||
                   (this.dbDateRange.startDate &&
                    filter.startDate === this.dbDateRange.startDate &&
                    filter.endDate === this.dbDateRange.endDate);
        }

        const temp = { startDate: '', endDate: '' };
        this.setQuickFilter(temp, range);
        return filter.startDate === temp.startDate && filter.endDate === temp.endDate;
    },

    // Build query string from filter
    buildQuery(filter) {
        const timezoneOffset = -new Date().getTimezoneOffset();
        let query = `?timezone_offset=${timezoneOffset}`;

        if (filter.startDate && filter.endDate) {
            query += `&start_date=${filter.startDate}&end_date=${filter.endDate}`;
        }
        return query;
    }
}" x-init="
    $watch('currentTab', value => onTabChange(value));
    $watch('statsFilter', value => refreshStats(), { deep: true });
    $watch('requestsFilter', value => loadRequests(), { deep: true });
    // Trigger initial load
    refreshStats();
">
    <h1>LLM Proxy Statistics</h1>

    <nav>
        <a href="#" :class="{ 'active': currentTab === 'stats' }" @click.prevent="currentTab = 'stats'">Stats</a>
        <a href="#" :class="{ 'active': currentTab === 'calendar' }" @click.prevent="currentTab = 'calendar'">Calendar</a>
        <a href="#" :class="{ 'active': currentTab === 'models' }" @click.prevent="currentTab = 'models'">Models</a>
        <a href="#" :class="{ 'active': currentTab === 'requests' }" @click.prevent="currentTab = 'requests'">Requests</a>
    </nav>

    <div id="stats-tab" x-show="currentTab === 'stats'">
        <div class="date-filter">
            <div class="filter-buttons">
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'all') }" @click="setQuickFilter(statsFilter, 'all')">All Time</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'today') }" @click="setQuickFilter(statsFilter, 'today')">Today</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'yesterday') }" @click="setQuickFilter(statsFilter, 'yesterday')">Yesterday</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'this-week') }" @click="setQuickFilter(statsFilter, 'this-week')">This Week</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'this-month') }" @click="setQuickFilter(statsFilter, 'this-month')">This Month</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'last-30-days') }" @click="setQuickFilter(statsFilter, 'last-30-days')">Last 30 Days</button>
            </div>

            <div class="filter-custom">
                <input type="date" x-model="statsFilter.startDate">
                <span>to</span>
                <input type="date" x-model="statsFilter.endDate">
            </div>
        </div>

        <div id="totals"></div>

        <h2>Provider Cost Breakdown</h2>
        <div id="provider-breakdown"></div>

        <h2>By Model</h2>
        <table id="by-model"></table>

        <h2>By Provider</h2>
        <table id="by-provider"></table>

        <h2>Recent Errors <button onclick="clearErrors()" style="margin-left: 10px;">Clear Errors</button></h2>
        <table id="errors"></table>
    </div>

    <div id="calendar-tab" x-show="currentTab === 'calendar'">
        <div class="calendar-header">
            <button id="prev-month" onclick="navigateMonth(-1)">←</button>
            <h2 id="current-month"></h2>
            <button id="next-month" onclick="navigateMonth(1)">→</button>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
        <div id="day-detail" style="display:none">
            <h3 id="day-detail-title"></h3>
            <div id="day-detail-content"></div>
        </div>
    </div>

    <div id="models-tab" x-show="currentTab === 'models'">
        <h2>Available Models</h2>
        <table id="models-list"></table>
    </div>

    <div id="requests-tab" x-show="currentTab === 'requests'">
        <div class="date-filter">
            <div class="filter-buttons">
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'all') }" @click="setQuickFilter(requestsFilter, 'all')">All Time</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'today') }" @click="setQuickFilter(requestsFilter, 'today')">Today</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'yesterday') }" @click="setQuickFilter(requestsFilter, 'yesterday')">Yesterday</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'this-week') }" @click="setQuickFilter(requestsFilter, 'this-week')">This Week</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'this-month') }" @click="setQuickFilter(requestsFilter, 'this-month')">This Month</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'last-30-days') }" @click="setQuickFilter(requestsFilter, 'last-30-days')">Last 30 Days</button>
            </div>

            <div class="filter-custom">
                <input type="date" x-model="requestsFilter.startDate">
                <span>to</span>
                <input type="date" x-model="requestsFilter.endDate">
            </div>
        </div>

        <h2>Recent Requests</h2>
        <table id="requests-list"></table>
    </div>

    <script>
        let expandedRequests = new Set();

        // Table sorting state: { tableId: { column: index, direction: 'asc'|'desc'|null, originalData: [] } }
        let tableSortState = {};

        function sortTable(tableId, columnIndex, data, renderCallback) {
            if (!tableSortState[tableId]) {
                tableSortState[tableId] = { column: null, direction: null, originalData: [...data] };
            }

            const state = tableSortState[tableId];

            // Cycle through: null -> asc -> desc -> null
            if (state.column === columnIndex) {
                if (state.direction === 'asc') {
                    state.direction = 'desc';
                } else if (state.direction === 'desc') {
                    state.direction = null;
                    state.column = null;
                } else {
                    state.direction = 'asc';
                }
            } else {
                state.column = columnIndex;
                state.direction = 'asc';
            }

            let sortedData;
            if (state.direction === null) {
                // Return to original order
                sortedData = [...state.originalData];
            } else {
                sortedData = [...data].sort((a, b) => {
                    let aVal = a[columnIndex];
                    let bVal = b[columnIndex];

                    // Handle null/undefined
                    if (aVal == null) return state.direction === 'asc' ? 1 : -1;
                    if (bVal == null) return state.direction === 'asc' ? -1 : 1;

                    // Detect type and compare
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return state.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    }

                    // String comparison (case-insensitive)
                    const aStr = String(aVal).toLowerCase();
                    const bStr = String(bVal).toLowerCase();
                    const comparison = aStr.localeCompare(bStr);
                    return state.direction === 'asc' ? comparison : -comparison;
                });
            }

            renderCallback(sortedData, state);
        }

        function makeSortableHeader(tableId, headers, onSort) {
            return headers.map((header, i) =>
                `<th class="sortable" onclick="${onSort}(${i})">${header}</th>`
            ).join('');
        }

        function updateSortIndicators(tableElement, state) {
            const headers = tableElement.querySelectorAll('th.sortable');
            headers.forEach((th, i) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (state && state.column === i) {
                    th.classList.add(state.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        function onTabChange(tab) {
            if (tab === 'calendar') loadCalendar();
            if (tab === 'models') loadModels();
            if (tab === 'requests') loadRequests();
        }

        let modelsData = [];

        async function loadModels() {
            const res = await fetch('/models');
            const data = await res.json();

            // Convert to array format for sorting: [name, provider, litellm_model, input_cost, output_cost]
            modelsData = data.models.map(m => [
                m.name,
                m.provider,
                m.litellm_model,
                m.input_cost_per_million || 0,
                m.output_cost_per_million || 0
            ]);

            renderModelsTable(modelsData, tableSortState['models-list']);
        }

        function sortModelsTable(columnIndex) {
            sortTable('models-list', columnIndex, modelsData, renderModelsTable);
        }

        function renderModelsTable(data, sortState) {
            const table = document.getElementById('models-list');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortModelsTable(0)">Name</th>
                        <th class="sortable" onclick="sortModelsTable(1)">Provider</th>
                        <th class="sortable" onclick="sortModelsTable(2)">LiteLLM Model</th>
                        <th class="sortable" onclick="sortModelsTable(3)">Input Cost/1M</th>
                        <th class="sortable" onclick="sortModelsTable(4)">Output Cost/1M</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td>${row[3] ? '$' + row[3].toFixed(2) : 'N/A'}</td>
                            <td>${row[4] ? '$' + row[4].toFixed(2) : 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderJsonTree(obj, isRoot = true) {
            if (obj === null) return '<span class="json-null">null</span>';
            if (obj === undefined) return '<span class="json-null">undefined</span>';

            const type = typeof obj;
            if (type === 'string') return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
            if (type === 'number') return `<span class="json-number">${obj}</span>`;
            if (type === 'boolean') return `<span class="json-boolean">${obj}</span>`;

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '<span>[]</span>';

                const id = 'json-' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span>[`;
                html += `<div id="${id}" class="json-line">`;
                obj.forEach((item, i) => {
                    html += renderJsonTree(item, false);
                    if (i < obj.length - 1) html += ',';
                    html += '<br>';
                });
                html += '</div>]';
                return html;
            }

            if (type === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '<span>{}</span>';

                const id = 'json-' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span>{`;
                html += `<div id="${id}" class="json-line">`;
                keys.forEach((key, i) => {
                    html += `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                    html += renderJsonTree(obj[key], false);
                    if (i < keys.length - 1) html += ',';
                    html += '<br>';
                });
                html += '</div>}';
                return html;
            }

            return String(obj);
        }

        function toggleJson(id) {
            const el = document.getElementById(id);
            const toggle = el.previousElementSibling;
            if (el.classList.contains('json-collapsed')) {
                el.classList.remove('json-collapsed');
                toggle.textContent = '▼';
            } else {
                el.classList.add('json-collapsed');
                toggle.textContent = '▶';
            }
        }

        let requestsData = [];
        let requestsObjects = []; // Store original request objects for detail rows

        async function loadRequests() {
            if (!alpineData) return;
            try {
                const query = alpineData.buildQuery(alpineData.requestsFilter);
                const url = `/requests${query}`;
                const res = await fetch(url);
                const data = await res.json();

                // Store original objects and convert to array format for sorting
                requestsObjects = data.requests;
                requestsData = data.requests.map(r => [
                    new Date(r.timestamp + 'Z').getTime(), // For sorting by time
                    r.model,
                    r.total_tokens,
                    r.cost,
                    r.duration_ms,
                    r.timestamp // Store timestamp for detail row lookup
                ]);

                renderRequestsTable(requestsData, tableSortState['requests-list']);
            } catch(e) {
                document.getElementById('requests-list').innerHTML = '<tr><td colspan="5">Error loading requests</td></tr>';
            }
        }

        function sortRequestsTable(columnIndex) {
            sortTable('requests-list', columnIndex, requestsData, renderRequestsTable);
        }

        function renderRequestsTable(data, sortState) {
            const tbody = document.createElement('tbody');

            data.forEach(row => {
                const timestamp = row[5];
                const requestObj = requestsObjects.find(r => r.timestamp === timestamp);
                if (!requestObj) return;

                let requestHtml = '<span class="error">Error parsing request</span>';
                let responseHtml = '<span class="error">Error parsing response</span>';

                try {
                    const req = JSON.parse(requestObj.request_data);
                    requestHtml = renderJsonTree(req);
                } catch(e) {}

                try {
                    const resp = JSON.parse(requestObj.response_data);
                    responseHtml = renderJsonTree(resp);
                } catch(e) {}

                const requestId = timestamp;

                // Create main row
                const mainRow = document.createElement('tr');
                mainRow.className = 'request-row';
                mainRow.onclick = () => toggleDetail(requestId);
                mainRow.innerHTML = `
                    <td>${escapeHtml(new Date(timestamp + 'Z').toLocaleString())}</td>
                    <td>${escapeHtml(row[1])}</td>
                    <td>${row[2]}</td>
                    <td>$${row[3].toFixed(4)}</td>
                    <td>${row[4]}ms</td>
                `;

                // Create detail row, restore expanded state
                const detailRow = document.createElement('tr');
                detailRow.id = 'detail-' + requestId;
                detailRow.style.display = expandedRequests.has(requestId) ? 'table-row' : 'none';
                detailRow.innerHTML = `
                    <td colspan="5" class="request-detail">
                        <b>Request:</b>
                        <div class="json-view json-tree">${requestHtml}</div>
                        <b>Response:</b>
                        <div class="json-view json-tree">${responseHtml}</div>
                    </td>
                `;

                tbody.appendChild(mainRow);
                tbody.appendChild(detailRow);
            });

            const table = document.getElementById('requests-list');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortRequestsTable(0)">Time</th>
                        <th class="sortable" onclick="sortRequestsTable(1)">Model</th>
                        <th class="sortable" onclick="sortRequestsTable(2)">Tokens</th>
                        <th class="sortable" onclick="sortRequestsTable(3)">Cost</th>
                        <th class="sortable" onclick="sortRequestsTable(4)">Duration</th>
                    </tr>
                </thead>
            `;
            table.appendChild(tbody);
            updateSortIndicators(table, sortState);
        }

        function toggleDetail(id) {
            const row = document.getElementById('detail-' + id);
            if (row) {
                const isHidden = row.style.display === 'none' || !row.style.display;
                row.style.display = isHidden ? 'table-row' : 'none';

                // Track expanded state
                if (isHidden) {
                    expandedRequests.add(id);
                } else {
                    expandedRequests.delete(id);
                }
            }
        }

        // Make Alpine data accessible to functions
        let alpineData = null;
        document.addEventListener('alpine:initialized', () => {
            alpineData = Alpine.$data(document.body);
        });

        let byModelData = [];
        let byProviderData = [];
        let errorsData = [];

        async function refreshStats() {
            if (!alpineData) return;
            const query = alpineData.buildQuery(alpineData.statsFilter);
            const url = `/stats${query}`;
            const res = await fetch(url);
            const data = await res.json();

            // Totals
            document.getElementById('totals').innerHTML = `
                <div class="metric">
                    <div class="metric-value">${data.totals.requests}</div>
                    <div class="metric-label">REQUESTS</div>
                </div>
                <div class="metric">
                    <div class="metric-value">$${data.totals.cost.toFixed(4)}</div>
                    <div class="metric-label">TOTAL COST</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(data.totals.prompt_tokens + data.totals.completion_tokens).toLocaleString()}</div>
                    <div class="metric-label">TOTAL TOKENS</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.totals.avg_duration_ms.toFixed(0)}ms</div>
                    <div class="metric-label">AVG DURATION</div>
                </div>
            `;

            // Provider breakdown visualization
            const totalCost = data.totals.cost;
            const providerColors = {
                'openai': '#10a37f',
                'anthropic': '#d97757',
                'google': '#4285f4'
            };

            let providerHtml = '';
            if (data.by_provider.length > 0 && totalCost > 0) {
                providerHtml = data.by_provider.map(p => {
                    const percentage = (p.cost / totalCost * 100);
                    const color = providerColors[p.provider] || '#999999';

                    return `
                        <div class="provider-bar">
                            <div class="provider-header">
                                <span class="provider-name">${p.provider}</span>
                                <span class="provider-percentage">${percentage.toFixed(0)}%</span>
                            </div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                            </div>
                            <div class="provider-details">
                                $${p.cost.toFixed(4)} across ${p.requests} requests ($${(p.cost / p.requests).toFixed(4)} per request)
                            </div>
                        </div>
                    `;
                }).join('');

                providerHtml += `<div style="margin-top: 20px; font-weight: bold;">Total: $${totalCost.toFixed(4)} (${data.totals.requests} requests)</div>`;
            } else {
                providerHtml = '<div style="color: #666;">No data available</div>';
            }

            document.getElementById('provider-breakdown').innerHTML = providerHtml;

            // By model - convert to sortable format
            byModelData = data.by_model.map(m => [m.model, m.requests, m.cost, m.tokens]);
            renderByModelTable(byModelData, tableSortState['by-model']);

            // By provider - convert to sortable format
            byProviderData = data.by_provider.map(p => [p.provider, p.requests, p.cost, p.tokens]);
            renderByProviderTable(byProviderData, tableSortState['by-provider']);

            // Errors - convert to sortable format
            errorsData = data.recent_errors.map(e => [new Date(e.timestamp + 'Z').getTime(), e.model, e.error, e.timestamp]);
            renderErrorsTable(errorsData, tableSortState['errors']);
        }

        function sortByModelTable(columnIndex) {
            sortTable('by-model', columnIndex, byModelData, renderByModelTable);
        }

        function renderByModelTable(data, sortState) {
            const table = document.getElementById('by-model');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortByModelTable(0)">Model</th>
                        <th class="sortable" onclick="sortByModelTable(1)">Requests</th>
                        <th class="sortable" onclick="sortByModelTable(2)">Cost</th>
                        <th class="sortable" onclick="sortByModelTable(3)">Tokens</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>$${row[2].toFixed(4)}</td>
                            <td>${row[3].toLocaleString()}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        function sortByProviderTable(columnIndex) {
            sortTable('by-provider', columnIndex, byProviderData, renderByProviderTable);
        }

        function renderByProviderTable(data, sortState) {
            const table = document.getElementById('by-provider');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortByProviderTable(0)">Provider</th>
                        <th class="sortable" onclick="sortByProviderTable(1)">Requests</th>
                        <th class="sortable" onclick="sortByProviderTable(2)">Cost</th>
                        <th class="sortable" onclick="sortByProviderTable(3)">Tokens</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>$${row[2].toFixed(4)}</td>
                            <td>${row[3].toLocaleString()}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        function sortErrorsTable(columnIndex) {
            sortTable('errors', columnIndex, errorsData, renderErrorsTable);
        }

        function renderErrorsTable(data, sortState) {
            const table = document.getElementById('errors');
            if (data.length === 0) {
                table.innerHTML = '<tr><td>No errors</td></tr>';
                return;
            }

            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortErrorsTable(0)">Time</th>
                        <th class="sortable" onclick="sortErrorsTable(1)">Model</th>
                        <th class="sortable" onclick="sortErrorsTable(2)">Error</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${new Date(row[3] + 'Z').toLocaleString()}</td>
                            <td>${row[1]}</td>
                            <td class="error">${row[2]}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        async function clearErrors() {
            if (!confirm('Clear all errors from the database?')) return;
            await fetch('/errors', { method: 'DELETE' });
            refreshStats();
        }

        // Calendar functionality
        let currentMonth = new Date();
        let selectedDate = null;
        let calendarData = {};

        function getCostColor(cost, maxCost) {
            if (cost === 0) return '#f0f0f0';
            const ratio = Math.min(cost / (maxCost || 1), 1);
            const lightness = 100 - (ratio * 50);
            return `hsl(210, 100%, ${lightness}%)`;
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function loadCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const startDate = formatDate(firstDay);
            const endDate = formatDate(lastDay);

            // Get browser timezone offset in minutes from UTC (negative for west)
            const timezoneOffset = -new Date().getTimezoneOffset();

            const res = await fetch(`/stats/daily?start_date=${startDate}&end_date=${endDate}&timezone_offset=${timezoneOffset}`);
            const data = await res.json();

            calendarData = {};
            data.daily.forEach(day => {
                calendarData[day.date] = day;
            });

            renderCalendar(year, month);
        }

        function renderCalendar(year, month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const today = formatDate(new Date());
            const maxCost = Math.max(...Object.values(calendarData).map(d => d.cost), 0.01);

            let html = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = formatDate(new Date(year, month, day));
                const dayData = calendarData[date] || { requests: 0, cost: 0 };
                const bgColor = getCostColor(dayData.cost, maxCost);
                const isToday = date === today ? 'today' : '';

                html += `
                    <div class="calendar-day ${isToday}"
                         style="background-color: ${bgColor}"
                         onclick="onDayClick('${date}')"
                         data-date="${date}">
                        <div class="day-number">${day}</div>
                        <div class="day-cost">$${dayData.cost.toFixed(2)}</div>
                        <div class="day-requests">${dayData.requests} req</div>
                    </div>
                `;
            }

            document.getElementById('calendar-grid').innerHTML = html;
        }

        function navigateMonth(direction) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
            loadCalendar();
        }

        function onDayClick(date) {
            selectedDate = date;
            const dayData = calendarData[date];

            if (!dayData || dayData.requests === 0) {
                document.getElementById('day-detail').style.display = 'none';
                return;
            }

            const detailTitle = document.getElementById('day-detail-title');
            const detailContent = document.getElementById('day-detail-content');

            detailTitle.textContent = `${date} - $${dayData.cost.toFixed(4)} across ${dayData.requests} requests`;

            let providersHtml = '<h4>By Provider:</h4>';
            const totalCost = dayData.cost;

            dayData.by_provider.forEach(p => {
                const percentage = totalCost > 0 ? (p.cost / totalCost * 100) : 0;
                const providerColors = {
                    'openai': '#10a37f',
                    'anthropic': '#d97757',
                    'google': '#4285f4',
                    'unknown': '#999999'
                };
                const color = providerColors[p.provider] || '#999999';

                providersHtml += `
                    <div class="provider-bar">
                        <div class="provider-header">
                            <span class="provider-name">${p.provider}</span>
                            <span class="provider-percentage">${percentage.toFixed(0)}%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                        </div>
                        <div class="provider-details">
                            $${p.cost.toFixed(4)} across ${p.requests} requests
                        </div>
                    </div>
                `;
            });

            detailContent.innerHTML = providersHtml;
            document.getElementById('day-detail').style.display = 'block';
        }

        // Auto-refresh stats every 5 seconds (uses current filter state)
        setInterval(() => {
            if (alpineData && alpineData.currentTab === 'stats') {
                refreshStats();
            }
        }, 5000);

        // Load initial tab data after Alpine initializes
        document.addEventListener('alpine:initialized', () => {
            const initialTab = localStorage.getItem('_x_currentTab')?.replace(/['"]/g, '') || 'stats';
            onTabChange(initialTab);
        });
    </script>
</body>
</html>
