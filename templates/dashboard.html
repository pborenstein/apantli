<!DOCTYPE html>
<html>
<head>
    <title>LLM Proxy Stats</title>
    <script defer src="/static/alpine-persist.min.js"></script>
    <script defer src="/static/alpine.min.js"></script>
    <style>
        :root {
            /* Light mode colors */
            --color-primary: #1890ff;
            --color-primary-dark: #096dd9;
            --color-primary-light: #40a9ff;

            /* Provider colors */
            --color-openai: #10a37f;
            --color-anthropic: #d97757;
            --color-google: #4285f4;
            --color-default: #999999;

            /* Semantic colors */
            --color-success: #52c41a;
            --color-warning: #faad14;
            --color-error: #f5222d;

            /* Neutrals - Light mode */
            --color-text: #262626;
            --color-text-secondary: #8c8c8c;
            --color-border: #d9d9d9;
            --color-background: #ffffff;
            --color-background-secondary: #fafafa;
            --color-background-tertiary: #f0f0f0;
            --color-hover: #f5f5f5;
            --color-shadow: rgba(0, 0, 0, 0.15);

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Typography */
            --font-mono: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            --font-system: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --color-text: #e8e8e8;
            --color-text-secondary: #a8a8a8;
            --color-border: #404040;
            --color-background: #1a1a1a;
            --color-background-secondary: #242424;
            --color-background-tertiary: #2a2a2a;
            --color-hover: #2f2f2f;
            --color-shadow: rgba(0, 0, 0, 0.5);
        }

        * {
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        body {
            font-family: var(--font-mono);
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
            background-color: var(--color-background);
            color: var(--color-text);
        }

        h1 {
            border-bottom: 2px solid var(--color-text);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h2 {
            margin-top: 30px;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            text-align: left;
            padding: var(--spacing-sm);
            border-bottom: 1px solid var(--color-border);
        }

        th {
            background: var(--color-background-tertiary);
            color: var(--color-text);
        }

        .metric {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-text);
        }

        .metric-label {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .error {
            color: var(--color-error);
        }

        .request-row {
            cursor: pointer;
        }

        .request-row:hover {
            background: var(--color-hover);
        }

        .request-detail {
            padding: 10px;
            background: var(--color-background-secondary);
        }

        /* Enhanced request detail styles */
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-border);
        }

        .detail-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-stat {
            font-size: 12px;
        }

        .detail-stat-label {
            color: var(--color-text-secondary);
        }

        .detail-stat-value {
            font-weight: bold;
            color: var(--color-text);
        }

        .detail-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .toggle-btn {
            padding: 4px 12px;
            border: 1px solid var(--color-border);
            background: var(--color-background);
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--color-text);
        }

        .toggle-btn:hover {
            background: var(--color-hover);
        }

        .toggle-btn.active {
            background: var(--color-text);
            color: var(--color-background);
        }

        .conversation-view {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        .message-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-role {
            font-weight: bold;
            color: var(--color-text);
        }

        .message-meta {
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
            color: var(--color-text);
        }

        .copy-btn {
            padding: 2px 8px;
            border: 1px solid var(--color-border);
            background: var(--color-background-secondary);
            border-radius: 3px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--color-text);
        }

        .copy-btn:hover {
            background: var(--color-hover);
        }

        .copy-btn:active {
            background: var(--color-success);
            color: white;
        }

        /* Code highlighting */
        .message-text pre {
            background: var(--color-background-tertiary);
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-text code {
            font-family: var(--font-mono);
            font-size: 12px;
        }

        .message-text :not(pre) > code {
            background: var(--color-background-tertiary);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .json-view {
            font-size: 11px;
            overflow-x: auto;
            margin: 5px 0;
        }

        .json-tree {
            font-family: var(--font-mono);
            line-height: 1.4;
        }

        .json-key { color: #881391; }
        .json-string { color: #1A1AA6; }
        .json-number { color: #1C00CF; }
        .json-boolean { color: #0D22AA; }
        .json-null { color: #808080; }

        [data-theme="dark"] .json-key { color: #c678dd; }
        [data-theme="dark"] .json-string { color: #98c379; }
        [data-theme="dark"] .json-number { color: #d19a66; }
        [data-theme="dark"] .json-boolean { color: #61afef; }
        [data-theme="dark"] .json-null { color: #888888; }

        .json-toggle {
            cursor: pointer;
            user-select: none;
            display: inline-block;
            width: 12px;
        }

        .json-toggle:hover {
            background: var(--color-hover);
        }

        .json-line {
            margin-left: 20px;
        }

        .json-collapsed {
            display: none;
        }

        nav {
            margin: 20px 0;
            border-bottom: 1px solid var(--color-border);
        }

        nav a {
            display: inline-block;
            padding: 10px 20px;
            text-decoration: none;
            color: var(--color-text);
        }

        nav a.active {
            border-bottom: 2px solid var(--color-text);
            font-weight: bold;
        }

        /* Theme toggle button */
        .theme-toggle {
            background: var(--color-background-secondary);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--color-text);
        }

        .theme-toggle:hover {
            background: var(--color-hover);
        }

        /* Calendar styles */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .calendar-header button {
            padding: 8px 16px;
            font-size: 18px;
            cursor: pointer;
            border: 1px solid var(--color-border);
            background: var(--color-background-secondary);
            color: var(--color-text);
            border-radius: 4px;
        }

        .calendar-header button:hover {
            background: var(--color-hover);
        }

        .calendar-header h2 {
            margin: 0;
            min-width: 200px;
            text-align: center;
            color: var(--color-text);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin: 20px 0;
        }

        .calendar-day-header {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            background: var(--color-background-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .calendar-day {
            aspect-ratio: 1;
            padding: 8px;
            border: 1px solid var(--color-border);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 80px;
        }

        .calendar-day:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px var(--color-shadow);
        }

        .calendar-day.today {
            border: 2px solid var(--color-primary);
        }

        .calendar-day.empty {
            background: var(--color-background-secondary);
            cursor: default;
        }

        .calendar-day.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .day-number {
            font-size: 14px;
            font-weight: bold;
            color: var(--color-text);
        }

        .day-cost {
            font-size: 12px;
            font-weight: bold;
            color: var(--color-text);
            margin: 4px 0;
        }

        .day-requests {
            font-size: 10px;
            color: var(--color-text-secondary);
        }

        #day-detail {
            margin-top: 30px;
            padding: 20px;
            background: var(--color-background-secondary);
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        #day-detail h3 {
            margin-top: 0;
            color: var(--color-text);
        }

        .provider-bar {
            margin: 15px 0;
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--color-text);
        }

        .bar-container {
            height: 24px;
            background: var(--color-background-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .provider-details {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        /* Provider trends chart styles */
        #provider-trends-chart {
            margin: 20px 0;
            padding: 20px;
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 4px;
        }

        .chart-svg {
            width: 100%;
            height: 300px;
            overflow: visible;
        }

        .chart-line {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .chart-dot {
            fill: var(--color-background);
            stroke-width: 2;
            cursor: pointer;
        }

        .chart-dot:hover {
            r: 5;
        }

        .chart-axis {
            stroke: var(--color-border);
            stroke-width: 1;
        }

        .chart-axis-text {
            fill: var(--color-text-secondary);
            font-size: 11px;
            font-family: var(--font-mono);
        }

        .chart-grid {
            stroke: var(--color-border);
            stroke-width: 1;
            opacity: 0.3;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .chart-legend-item:hover {
            background: var(--color-hover);
        }

        .chart-legend-item.inactive {
            opacity: 0.3;
        }

        .chart-legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }

        .chart-legend-label {
            font-size: 12px;
            color: var(--color-text);
            font-family: var(--font-mono);
        }

        .chart-tooltip {
            position: absolute;
            background: var(--color-background-secondary);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 11px;
            pointer-events: none;
            box-shadow: 0 2px 8px var(--color-shadow);
            z-index: 1000;
            display: none;
        }

        .chart-tooltip-date {
            font-weight: bold;
            margin-bottom: 4px;
            color: var(--color-text);
        }

        .chart-tooltip-item {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            color: var(--color-text);
        }

        .chart-empty {
            text-align: center;
            padding: 40px;
            color: var(--color-text-secondary);
        }

        /* Date filter styles */
        .date-filter {
            background: var(--color-background-secondary);
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid var(--color-border);
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            background: var(--color-background);
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 13px;
            color: var(--color-text);
        }

        .filter-btn:hover {
            background: var(--color-hover);
        }

        .filter-btn.active {
            background: var(--color-text);
            color: var(--color-background);
            border-color: var(--color-text);
        }

        .filter-custom {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-custom input[type="date"] {
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 13px;
            background: var(--color-background);
            color: var(--color-text);
        }

        .filter-custom span {
            color: var(--color-text-secondary);
            font-size: 13px;
        }

        /* Request filter styles */
        .request-filters {
            background: var(--color-background-secondary);
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid var(--color-border);
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-search {
            flex: 1;
            min-width: 300px;
        }

        .filter-search label {
            display: block;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .filter-search input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-family: var(--font-mono);
            background: var(--color-background);
            color: var(--color-text);
        }

        .filter-select {
            flex: 1;
            min-width: 150px;
        }

        .filter-select label {
            display: block;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .filter-select select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-family: var(--font-mono);
            background: var(--color-background);
            color: var(--color-text);
        }

        .filter-cost-range {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .filter-cost-range label {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .filter-cost-range input {
            width: 90px;
            padding: 6px 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-family: var(--font-mono);
            background: var(--color-background);
            color: var(--color-text);
        }

        .filter-cost-range span {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        /* Request summary styles */
        .request-summary {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            margin: 20px 0;
        }

        .summary-metric {
            text-align: center;
        }

        .summary-metric .metric-value {
            display: block;
            font-size: 20px;
            font-weight: bold;
            color: var(--color-text);
        }

        .summary-metric .metric-label {
            display: block;
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        /* Sortable table styles */
        th.sortable {
            cursor: pointer;
            user-select: none;
        }

        th.sortable:hover {
            background: var(--color-hover);
        }

        th.sortable::after {
            content: ' ⇅';
            color: var(--color-text-secondary);
            font-size: 10px;
        }

        th.sortable.sort-asc::after {
            content: ' ▲';
            color: var(--color-text);
        }

        th.sortable.sort-desc::after {
            content: ' ▼';
            color: var(--color-text);
        }

        /* Focus indicators */
        button:focus,
        input:focus,
        select:focus,
        a:focus,
        .calendar-day:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        button:focus:not(:focus-visible),
        input:focus:not(:focus-visible),
        select:focus:not(:focus-visible),
        a:focus:not(:focus-visible),
        .calendar-day:focus:not(:focus-visible) {
            outline: none;
        }

        /* Loading spinner */
        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            color: var(--color-text-secondary);
        }

        .spinner {
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error banner */
        .error-banner {
            display: none;
            padding: 15px;
            margin: 20px 0;
            background: var(--color-error);
            color: white;
            border-radius: 4px;
            font-weight: bold;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                margin: 10px;
                padding: 0 10px;
            }

            .metric {
                display: block;
                margin: 10px 0;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 4px;
            }

            .calendar-grid {
                gap: 1px;
            }

            .calendar-day {
                padding: 4px;
                min-height: 60px;
            }

            .day-cost {
                font-size: 10px;
            }

            .day-requests {
                font-size: 8px;
            }

            .filter-buttons {
                flex-direction: column;
            }

            .filter-btn {
                width: 100%;
            }

            .filter-custom {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-search,
            .filter-select {
                min-width: 100%;
            }

            .request-summary {
                flex-direction: column;
                gap: 10px;
            }

            h1 {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body x-data="{
    currentTab: $persist('stats'),
    theme: $persist('light'),
    statsFilter: $persist({
        startDate: '',
        endDate: ''
    }),
    requestsFilter: $persist({
        startDate: '',
        endDate: ''
    }),
    dbDateRange: { startDate: null, endDate: null },

    toggleTheme() {
        this.theme = this.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', this.theme);
    },

    formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    },

    // Set filter to quick range
    async setQuickFilter(filter, range) {
        const today = new Date();

        switch(range) {
            case 'all':
                // Fetch actual date range from database
                try {
                    const res = await fetch('/stats/date-range');
                    const data = await res.json();
                    if (data.start_date && data.end_date) {
                        this.dbDateRange.startDate = data.start_date;
                        this.dbDateRange.endDate = data.end_date;
                        filter.startDate = data.start_date;
                        filter.endDate = data.end_date;
                    } else {
                        filter.startDate = '';
                        filter.endDate = '';
                    }
                } catch (e) {
                    filter.startDate = '';
                    filter.endDate = '';
                }
                break;
            case 'today':
                filter.startDate = filter.endDate = this.formatDate(today);
                break;
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                filter.startDate = filter.endDate = this.formatDate(yesterday);
                break;
            case 'this-week':
                const weekStart = new Date(today);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                filter.startDate = this.formatDate(weekStart);
                filter.endDate = this.formatDate(weekEnd);
                break;
            case 'this-month':
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                filter.startDate = this.formatDate(monthStart);
                filter.endDate = this.formatDate(monthEnd);
                break;
            case 'last-30-days':
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filter.startDate = this.formatDate(thirtyDaysAgo);
                filter.endDate = this.formatDate(today);
                break;
        }
    },

    // Check if filter matches a quick range
    isQuickActive(filter, range) {
        if (range === 'all') {
            // Check if it matches the database range or is empty
            return (!filter.startDate && !filter.endDate) ||
                   (this.dbDateRange.startDate &&
                    filter.startDate === this.dbDateRange.startDate &&
                    filter.endDate === this.dbDateRange.endDate);
        }

        const temp = { startDate: '', endDate: '' };
        this.setQuickFilter(temp, range);
        return filter.startDate === temp.startDate && filter.endDate === temp.endDate;
    },

    // Build query string from filter
    buildQuery(filter) {
        const timezoneOffset = -new Date().getTimezoneOffset();
        let query = `?timezone_offset=${timezoneOffset}`;

        if (filter.startDate && filter.endDate) {
            query += `&start_date=${filter.startDate}&end_date=${filter.endDate}`;
        }
        return query;
    }
}" x-init="
    // Set initial theme
    document.documentElement.setAttribute('data-theme', theme);
    $watch('currentTab', value => onTabChange(value));
    $watch('theme', value => {
        // Reload calendar when theme changes to update colors
        if (currentTab === 'calendar') {
            loadCalendar();
        }
    });
    $watch('statsFilter', value => refreshStats(), { deep: true });
    $watch('requestsFilter', value => loadRequests(), { deep: true });
">
    <h1>
        <span>LLM Proxy Statistics</span>
        <button class="theme-toggle" @click="toggleTheme()" :aria-label="theme === 'light' ? 'Switch to dark mode' : 'Switch to light mode'">
            <span x-show="theme === 'light'">Dark Mode</span>
            <span x-show="theme === 'dark'">Light Mode</span>
        </button>
    </h1>

    <div id="error-banner" class="error-banner" role="alert"></div>
    <div id="chart-tooltip" class="chart-tooltip"></div>

    <nav>
        <a href="#" :class="{ 'active': currentTab === 'stats' }" @click.prevent="currentTab = 'stats'">Stats</a>
        <a href="#" :class="{ 'active': currentTab === 'calendar' }" @click.prevent="currentTab = 'calendar'">Calendar</a>
        <a href="#" :class="{ 'active': currentTab === 'models' }" @click.prevent="currentTab = 'models'">Models</a>
        <a href="#" :class="{ 'active': currentTab === 'requests' }" @click.prevent="currentTab = 'requests'">Requests</a>
    </nav>

    <div id="stats-tab" x-show="currentTab === 'stats'">
        <div class="date-filter">
            <div class="filter-buttons">
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'all') }" @click="setQuickFilter(statsFilter, 'all')">All Time</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'today') }" @click="setQuickFilter(statsFilter, 'today')">Today</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'yesterday') }" @click="setQuickFilter(statsFilter, 'yesterday')">Yesterday</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'this-week') }" @click="setQuickFilter(statsFilter, 'this-week')">This Week</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'this-month') }" @click="setQuickFilter(statsFilter, 'this-month')">This Month</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(statsFilter, 'last-30-days') }" @click="setQuickFilter(statsFilter, 'last-30-days')">Last 30 Days</button>
            </div>

            <div class="filter-custom">
                <input type="date" x-model="statsFilter.startDate">
                <span>to</span>
                <input type="date" x-model="statsFilter.endDate">
            </div>
        </div>

        <div id="totals"></div>

        <h2>Provider Cost Breakdown</h2>
        <div id="provider-breakdown"></div>

        <h2>Provider Cost Trends</h2>
        <div id="provider-trends-chart"></div>

        <h2>By Model</h2>
        <table id="by-model"></table>

        <h2>By Provider</h2>
        <table id="by-provider"></table>

        <h2>Recent Errors <button onclick="clearErrors()" style="margin-left: 10px;">Clear Errors</button></h2>
        <table id="errors"></table>
    </div>

    <div id="calendar-tab" x-show="currentTab === 'calendar'">
        <div class="calendar-header">
            <button id="prev-month" onclick="navigateMonth(-1)" aria-label="Previous month">←</button>
            <h2 id="current-month"></h2>
            <button id="next-month" onclick="navigateMonth(1)" aria-label="Next month">→</button>
        </div>
        <div class="calendar-grid" id="calendar-grid" role="grid" aria-label="Monthly calendar"></div>
        <div id="day-detail" style="display:none" role="region" aria-live="polite">
            <h3 id="day-detail-title"></h3>
            <div id="day-detail-content"></div>
        </div>
    </div>

    <div id="models-tab" x-show="currentTab === 'models'">
        <h2>Available Models</h2>
        <table id="models-list"></table>
    </div>

    <div id="requests-tab" x-show="currentTab === 'requests'">
        <div class="date-filter">
            <div class="filter-buttons">
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'all') }" @click="setQuickFilter(requestsFilter, 'all')">All Time</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'today') }" @click="setQuickFilter(requestsFilter, 'today')">Today</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'yesterday') }" @click="setQuickFilter(requestsFilter, 'yesterday')">Yesterday</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'this-week') }" @click="setQuickFilter(requestsFilter, 'this-week')">This Week</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'this-month') }" @click="setQuickFilter(requestsFilter, 'this-month')">This Month</button>
                <button class="filter-btn" :class="{ 'active': isQuickActive(requestsFilter, 'last-30-days') }" @click="setQuickFilter(requestsFilter, 'last-30-days')">Last 30 Days</button>
            </div>

            <div class="filter-custom">
                <input type="date" x-model="requestsFilter.startDate">
                <span>to</span>
                <input type="date" x-model="requestsFilter.endDate">
            </div>
        </div>

        <div class="request-filters">
            <div class="filter-row">
                <div class="filter-search">
                    <label for="search-requests">Search:</label>
                    <input type="text" id="search-requests" placeholder="Search in model or content..." oninput="applyRequestFilters()">
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-select">
                    <label for="filter-provider">Provider:</label>
                    <select id="filter-provider" onchange="applyRequestFilters()">
                        <option value="all">All</option>
                    </select>
                </div>

                <div class="filter-select">
                    <label for="filter-model">Model:</label>
                    <select id="filter-model" onchange="applyRequestFilters()">
                        <option value="all">All</option>
                    </select>
                </div>

                <div class="filter-cost-range">
                    <label>Cost Range:</label>
                    <input type="number" id="min-cost" placeholder="Min $" step="0.0001" min="0" oninput="applyRequestFilters()">
                    <span>to</span>
                    <input type="number" id="max-cost" placeholder="Max $" step="0.0001" min="0" oninput="applyRequestFilters()">
                </div>
            </div>
        </div>

        <div id="request-summary" style="display: none;" class="request-summary">
            <div class="summary-metric">
                <span class="metric-value" id="summary-count">0</span>
                <span class="metric-label">Requests</span>
            </div>
            <div class="summary-metric">
                <span class="metric-value" id="summary-cost">$0.00</span>
                <span class="metric-label">Total Cost</span>
            </div>
            <div class="summary-metric">
                <span class="metric-value" id="summary-tokens">0</span>
                <span class="metric-label">Tokens</span>
            </div>
            <div class="summary-metric">
                <span class="metric-value" id="summary-avg-cost">$0.00</span>
                <span class="metric-label">Avg Cost</span>
            </div>
        </div>

        <h2>Recent Requests</h2>
        <table id="requests-list"></table>
    </div>

    <script>
        // Error handling utilities
        function showError(message) {
            const errorBanner = document.getElementById('error-banner');
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
            setTimeout(() => {
                errorBanner.style.display = 'none';
            }, 5000);
        }

        function hideError() {
            const errorBanner = document.getElementById('error-banner');
            errorBanner.style.display = 'none';
        }

        // Fetch with error handling
        async function fetchWithErrorHandling(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                return await res.json();
            } catch (err) {
                showError(`Failed to load data: ${err.message}`);
                return null;
            }
        }

        let expandedRequests = new Set();
        let detailViewMode = {}; // Track view mode per request: 'conversation' or 'json'

        // Table sorting state: { tableId: { column: index, direction: 'asc'|'desc'|null, originalData: [] } }
        let tableSortState = {};

        // Extract conversation messages from request/response
        function extractConversation(requestObj) {
            try {
                const request = JSON.parse(requestObj.request_data);
                const response = JSON.parse(requestObj.response_data);

                const messages = [];

                // Extract request messages
                if (request.messages && Array.isArray(request.messages)) {
                    request.messages.forEach(msg => {
                        messages.push({
                            role: msg.role,
                            content: msg.content,
                            isRequest: true
                        });
                    });
                }

                // Extract response message
                if (response.choices && response.choices[0] && response.choices[0].message) {
                    const assistantMsg = response.choices[0].message;
                    messages.push({
                        role: assistantMsg.role || 'assistant',
                        content: assistantMsg.content,
                        isRequest: false
                    });
                }

                return messages;
            } catch (e) {
                return null;
            }
        }

        // Estimate token count for a message (rough approximation)
        function estimateTokens(text) {
            if (!text) return 0;
            // Rough estimate: ~4 characters per token
            return Math.ceil(text.length / 4);
        }

        // Format message content with markdown-like code block detection
        function formatMessageContent(content) {
            if (!content) return '';

            // Escape HTML
            const escaped = escapeHtml(content);

            // Convert markdown code blocks to HTML
            let formatted = escaped.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code>${code.trim()}</code></pre>`;
            });

            // Convert inline code
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            return formatted;
        }

        // Copy text to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render conversation view
        function renderConversationView(requestObj) {
            const messages = extractConversation(requestObj);
            if (!messages) {
                return '<p class="error">Could not extract conversation from request/response data</p>';
            }

            let html = '<div class="conversation-view">';

            messages.forEach((msg, index) => {
                const icon = msg.role === 'user' ? '⊙' : msg.role === 'assistant' ? '◈' : '⚙';
                const roleLabel = msg.role.charAt(0).toUpperCase() + msg.role.slice(1);
                const tokens = estimateTokens(msg.content);
                const formattedContent = formatMessageContent(msg.content);

                html += `
                    <div class="message">
                        <div class="message-icon">${icon}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <div>
                                    <span class="message-role">${roleLabel}</span>
                                    <span class="message-meta">~${tokens.toLocaleString()} tokens</span>
                                </div>
                                <button class="copy-btn" onclick="copyToClipboard(\`${escapeHtml(msg.content).replace(/`/g, '\\`')}\`, this)">Copy</button>
                            </div>
                            <div class="message-text">${formattedContent}</div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // Toggle between conversation and JSON view
        function toggleDetailView(requestId, mode) {
            detailViewMode[requestId] = mode;
            const requestObj = requestsObjects.find(r => r.timestamp === requestId);
            if (!requestObj) return;

            const detailRow = document.getElementById('detail-' + requestId);
            const contentDiv = detailRow.querySelector('.detail-content');

            if (mode === 'conversation') {
                contentDiv.innerHTML = renderConversationView(requestObj);
            } else {
                // JSON view
                let requestHtml = '<span class="error">Error parsing request</span>';
                let responseHtml = '<span class="error">Error parsing response</span>';

                try {
                    const req = JSON.parse(requestObj.request_data);
                    requestHtml = renderJsonTree(req);
                } catch(e) {}

                try {
                    const resp = JSON.parse(requestObj.response_data);
                    responseHtml = renderJsonTree(resp);
                } catch(e) {}

                contentDiv.innerHTML = `
                    <b>Request:</b>
                    <div class="json-view json-tree">${requestHtml}</div>
                    <b>Response:</b>
                    <div class="json-view json-tree">${responseHtml}</div>
                `;
            }

            // Update toggle buttons
            detailRow.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
        }

        function sortTable(tableId, columnIndex, data, renderCallback) {
            if (!tableSortState[tableId]) {
                tableSortState[tableId] = { column: null, direction: null, originalData: [...data] };
            }

            const state = tableSortState[tableId];

            // Cycle through: null -> asc -> desc -> null
            if (state.column === columnIndex) {
                if (state.direction === 'asc') {
                    state.direction = 'desc';
                } else if (state.direction === 'desc') {
                    state.direction = null;
                    state.column = null;
                } else {
                    state.direction = 'asc';
                }
            } else {
                state.column = columnIndex;
                state.direction = 'asc';
            }

            let sortedData;
            if (state.direction === null) {
                // Return to original order
                sortedData = [...state.originalData];
            } else {
                sortedData = [...data].sort((a, b) => {
                    let aVal = a[columnIndex];
                    let bVal = b[columnIndex];

                    // Handle null/undefined
                    if (aVal == null) return state.direction === 'asc' ? 1 : -1;
                    if (bVal == null) return state.direction === 'asc' ? -1 : 1;

                    // Detect type and compare
                    if (typeof aVal === 'number' && typeof bVal === 'number') {
                        return state.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    }

                    // String comparison (case-insensitive)
                    const aStr = String(aVal).toLowerCase();
                    const bStr = String(bVal).toLowerCase();
                    const comparison = aStr.localeCompare(bStr);
                    return state.direction === 'asc' ? comparison : -comparison;
                });
            }

            renderCallback(sortedData, state);
        }

        function makeSortableHeader(tableId, headers, onSort) {
            return headers.map((header, i) =>
                `<th class="sortable" onclick="${onSort}(${i})">${header}</th>`
            ).join('');
        }

        function updateSortIndicators(tableElement, state) {
            const headers = tableElement.querySelectorAll('th.sortable');
            headers.forEach((th, i) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (state && state.column === i) {
                    th.classList.add(state.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        function applySortIfNeeded(tableId, data) {
            const state = tableSortState[tableId];
            if (!state || state.direction === null) {
                return data;
            }

            return [...data].sort((a, b) => {
                let aVal = a[state.column];
                let bVal = b[state.column];

                if (aVal == null) return state.direction === 'asc' ? 1 : -1;
                if (bVal == null) return state.direction === 'asc' ? -1 : 1;

                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return state.direction === 'asc' ? aVal - bVal : bVal - aVal;
                }

                const aStr = String(aVal).toLowerCase();
                const bStr = String(bVal).toLowerCase();
                const comparison = aStr.localeCompare(bStr);
                return state.direction === 'asc' ? comparison : -comparison;
            });
        }

        function onTabChange(tab) {
            if (tab === 'calendar') loadCalendar();
            if (tab === 'models') loadModels();
            if (tab === 'requests') loadRequests();
        }

        let modelsData = [];

        async function loadModels() {
            const res = await fetch('/models');
            const data = await res.json();

            // Convert to array format for sorting: [name, provider, litellm_model, input_cost, output_cost]
            modelsData = data.models.map(m => [
                m.name,
                m.provider,
                m.litellm_model,
                m.input_cost_per_million || 0,
                m.output_cost_per_million || 0
            ]);

            if (!tableSortState['models-list']) {
                tableSortState['models-list'] = { column: null, direction: null, originalData: [...modelsData] };
            } else {
                tableSortState['models-list'].originalData = [...modelsData];
            }
            renderModelsTable(applySortIfNeeded('models-list', modelsData), tableSortState['models-list']);
        }

        function sortModelsTable(columnIndex) {
            sortTable('models-list', columnIndex, modelsData, renderModelsTable);
        }

        function renderModelsTable(data, sortState) {
            const table = document.getElementById('models-list');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortModelsTable(0)">Name</th>
                        <th class="sortable" onclick="sortModelsTable(1)">Provider</th>
                        <th class="sortable" onclick="sortModelsTable(2)">LiteLLM Model</th>
                        <th class="sortable" onclick="sortModelsTable(3)">Input Cost/1M</th>
                        <th class="sortable" onclick="sortModelsTable(4)">Output Cost/1M</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td>${row[3] ? '$' + row[3].toFixed(2) : 'N/A'}</td>
                            <td>${row[4] ? '$' + row[4].toFixed(2) : 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderJsonTree(obj, isRoot = true) {
            if (obj === null) return '<span class="json-null">null</span>';
            if (obj === undefined) return '<span class="json-null">undefined</span>';

            const type = typeof obj;
            if (type === 'string') return `<span class="json-string">"${escapeHtml(obj)}"</span>`;
            if (type === 'number') return `<span class="json-number">${obj}</span>`;
            if (type === 'boolean') return `<span class="json-boolean">${obj}</span>`;

            if (Array.isArray(obj)) {
                if (obj.length === 0) return '<span>[]</span>';

                const id = 'json-' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span>[`;
                html += `<div id="${id}" class="json-line">`;
                obj.forEach((item, i) => {
                    html += renderJsonTree(item, false);
                    if (i < obj.length - 1) html += ',';
                    html += '<br>';
                });
                html += '</div>]';
                return html;
            }

            if (type === 'object') {
                const keys = Object.keys(obj);
                if (keys.length === 0) return '<span>{}</span>';

                const id = 'json-' + Math.random().toString(36).substr(2, 9);
                let html = `<span class="json-toggle" onclick="toggleJson('${id}')">▼</span>{`;
                html += `<div id="${id}" class="json-line">`;
                keys.forEach((key, i) => {
                    html += `<span class="json-key">"${escapeHtml(key)}"</span>: `;
                    html += renderJsonTree(obj[key], false);
                    if (i < keys.length - 1) html += ',';
                    html += '<br>';
                });
                html += '</div>}';
                return html;
            }

            return String(obj);
        }

        function toggleJson(id) {
            const el = document.getElementById(id);
            const toggle = el.previousElementSibling;
            if (el.classList.contains('json-collapsed')) {
                el.classList.remove('json-collapsed');
                toggle.textContent = '▼';
            } else {
                el.classList.add('json-collapsed');
                toggle.textContent = '▶';
            }
        }

        let requestsData = [];
        let requestsObjects = []; // Store original request objects for detail rows
        let filteredRequestsData = []; // Filtered subset
        let filteredRequestsObjects = []; // Filtered objects

        async function loadRequests() {
            if (!alpineData) return;
            try {
                const query = alpineData.buildQuery(alpineData.requestsFilter);
                const url = `/requests${query}`;
                const res = await fetch(url);
                const data = await res.json();

                // Store original objects and convert to array format for sorting
                requestsObjects = data.requests;
                requestsData = data.requests.map(r => [
                    new Date(r.timestamp + 'Z').getTime(), // For sorting by time
                    r.model,
                    r.total_tokens,
                    r.cost,
                    r.duration_ms,
                    r.timestamp // Store timestamp for detail row lookup
                ]);

                // Populate filter dropdowns
                populateFilterDropdowns();

                // Apply initial filtering
                applyRequestFilters();
            } catch(e) {
                document.getElementById('requests-list').innerHTML = '<tr><td colspan="5">Error loading requests</td></tr>';
            }
        }

        function populateFilterDropdowns() {
            // Get unique providers
            const providers = [...new Set(requestsObjects.map(r => r.provider).filter(Boolean))].sort();
            const providerSelect = document.getElementById('filter-provider');
            providerSelect.innerHTML = '<option value="all">All</option>';
            providers.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                providerSelect.appendChild(option);
            });

            // Get unique models
            const models = [...new Set(requestsObjects.map(r => r.model).filter(Boolean))].sort();
            const modelSelect = document.getElementById('filter-model');
            modelSelect.innerHTML = '<option value="all">All</option>';
            models.forEach(m => {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m;
                modelSelect.appendChild(option);
            });
        }

        function applyRequestFilters() {
            const searchText = document.getElementById('search-requests').value.toLowerCase();
            const filterProvider = document.getElementById('filter-provider').value;
            const filterModel = document.getElementById('filter-model').value;
            const minCost = parseFloat(document.getElementById('min-cost').value) || 0;
            const maxCost = parseFloat(document.getElementById('max-cost').value) || Infinity;

            // Filter objects first
            filteredRequestsObjects = requestsObjects.filter(r => {
                // Search filter
                if (searchText) {
                    const modelMatch = r.model.toLowerCase().includes(searchText);
                    let contentMatch = false;
                    try {
                        const content = r.request_data + r.response_data;
                        contentMatch = content.toLowerCase().includes(searchText);
                    } catch(e) {}
                    if (!modelMatch && !contentMatch) return false;
                }

                // Provider filter
                if (filterProvider !== 'all' && r.provider !== filterProvider) return false;

                // Model filter
                if (filterModel !== 'all' && r.model !== filterModel) return false;

                // Cost range filter
                if (r.cost < minCost || r.cost > maxCost) return false;

                return true;
            });

            // Convert filtered objects to array format
            filteredRequestsData = filteredRequestsObjects.map(r => [
                new Date(r.timestamp + 'Z').getTime(),
                r.model,
                r.total_tokens,
                r.cost,
                r.duration_ms,
                r.timestamp
            ]);

            // Update sort state with filtered data
            if (!tableSortState['requests-list']) {
                tableSortState['requests-list'] = { column: null, direction: null, originalData: [...filteredRequestsData] };
            } else {
                tableSortState['requests-list'].originalData = [...filteredRequestsData];
                // Reset sort when filters change
                tableSortState['requests-list'].column = null;
                tableSortState['requests-list'].direction = null;
            }

            // Update summary and render
            updateRequestSummary();
            renderRequestsTable(filteredRequestsData, tableSortState['requests-list']);
        }

        function updateRequestSummary() {
            const summary = document.getElementById('request-summary');

            if (filteredRequestsObjects.length === 0) {
                summary.style.display = 'none';
                return;
            }

            const count = filteredRequestsObjects.length;
            const totalCost = filteredRequestsObjects.reduce((sum, r) => sum + r.cost, 0);
            const totalTokens = filteredRequestsObjects.reduce((sum, r) => sum + r.total_tokens, 0);
            const avgCost = count > 0 ? totalCost / count : 0;

            document.getElementById('summary-count').textContent = count;
            document.getElementById('summary-cost').textContent = '$' + totalCost.toFixed(4);
            document.getElementById('summary-tokens').textContent = totalTokens.toLocaleString();
            document.getElementById('summary-avg-cost').textContent = '$' + avgCost.toFixed(4);

            summary.style.display = 'flex';
        }

        function sortRequestsTable(columnIndex) {
            sortTable('requests-list', columnIndex, filteredRequestsData, renderRequestsTable);
        }

        function renderRequestsTable(data, sortState) {
            const tbody = document.createElement('tbody');

            data.forEach(row => {
                const timestamp = row[5];
                const requestObj = requestsObjects.find(r => r.timestamp === timestamp);
                if (!requestObj) return;

                const requestId = timestamp;
                const currentMode = detailViewMode[requestId] || 'conversation';

                // Calculate cost breakdown
                const promptTokens = requestObj.prompt_tokens || 0;
                const completionTokens = requestObj.completion_tokens || 0;
                const totalTokens = requestObj.total_tokens || 0;
                const cost = requestObj.cost || 0;

                // Rough cost split based on token counts (not exact but reasonable)
                const promptCost = totalTokens > 0 ? (promptTokens / totalTokens) * cost : 0;
                const completionCost = cost - promptCost;

                // Create main row
                const mainRow = document.createElement('tr');
                mainRow.className = 'request-row';
                mainRow.onclick = () => toggleDetail(requestId);
                mainRow.innerHTML = `
                    <td>${escapeHtml(new Date(timestamp + 'Z').toLocaleString())}</td>
                    <td>${escapeHtml(row[1])}</td>
                    <td>${row[2].toLocaleString()}</td>
                    <td>$${row[3].toFixed(4)}</td>
                    <td>${row[4]}ms</td>
                `;

                // Create detail row, restore expanded state
                const detailRow = document.createElement('tr');
                detailRow.id = 'detail-' + requestId;
                detailRow.style.display = expandedRequests.has(requestId) ? 'table-row' : 'none';

                // Build detail content
                const detailHeader = `
                    <div class="detail-header">
                        <div class="detail-stats">
                            <div class="detail-stat">
                                <span class="detail-stat-label">Model: </span>
                                <span class="detail-stat-value">${escapeHtml(requestObj.model)}</span>
                            </div>
                            <div class="detail-stat">
                                <span class="detail-stat-label">Provider: </span>
                                <span class="detail-stat-value">${escapeHtml(requestObj.provider || 'unknown')}</span>
                            </div>
                            <div class="detail-stat">
                                <span class="detail-stat-label">Tokens: </span>
                                <span class="detail-stat-value">${promptTokens.toLocaleString()} in / ${completionTokens.toLocaleString()} out = ${totalTokens.toLocaleString()} total</span>
                            </div>
                            <div class="detail-stat">
                                <span class="detail-stat-label">Cost: </span>
                                <span class="detail-stat-value">$${cost.toFixed(4)} ($${promptCost.toFixed(4)} in + $${completionCost.toFixed(4)} out)</span>
                            </div>
                            <div class="detail-stat">
                                <span class="detail-stat-label">Duration: </span>
                                <span class="detail-stat-value">${requestObj.duration_ms}ms</span>
                            </div>
                        </div>
                    </div>
                `;

                const toggleButtons = `
                    <div class="detail-toggle">
                        <button class="toggle-btn ${currentMode === 'conversation' ? 'active' : ''}" data-mode="conversation" onclick="event.stopPropagation(); toggleDetailView('${requestId}', 'conversation')">Conversation</button>
                        <button class="toggle-btn ${currentMode === 'json' ? 'active' : ''}" data-mode="json" onclick="event.stopPropagation(); toggleDetailView('${requestId}', 'json')">Raw JSON</button>
                    </div>
                `;

                // Generate initial content
                let contentHtml = '';
                if (currentMode === 'conversation') {
                    contentHtml = renderConversationView(requestObj);
                } else {
                    let requestHtml = '<span class="error">Error parsing request</span>';
                    let responseHtml = '<span class="error">Error parsing response</span>';

                    try {
                        const req = JSON.parse(requestObj.request_data);
                        requestHtml = renderJsonTree(req);
                    } catch(e) {}

                    try {
                        const resp = JSON.parse(requestObj.response_data);
                        responseHtml = renderJsonTree(resp);
                    } catch(e) {}

                    contentHtml = `
                        <b>Request:</b>
                        <div class="json-view json-tree">${requestHtml}</div>
                        <b>Response:</b>
                        <div class="json-view json-tree">${responseHtml}</div>
                    `;
                }

                detailRow.innerHTML = `
                    <td colspan="5" class="request-detail">
                        ${detailHeader}
                        ${toggleButtons}
                        <div class="detail-content">
                            ${contentHtml}
                        </div>
                    </td>
                `;

                tbody.appendChild(mainRow);
                tbody.appendChild(detailRow);
            });

            const table = document.getElementById('requests-list');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortRequestsTable(0)">Time</th>
                        <th class="sortable" onclick="sortRequestsTable(1)">Model</th>
                        <th class="sortable" onclick="sortRequestsTable(2)">Tokens</th>
                        <th class="sortable" onclick="sortRequestsTable(3)">Cost</th>
                        <th class="sortable" onclick="sortRequestsTable(4)">Duration</th>
                    </tr>
                </thead>
            `;
            table.appendChild(tbody);
            updateSortIndicators(table, sortState);
        }

        function toggleDetail(id) {
            const row = document.getElementById('detail-' + id);
            if (row) {
                const isHidden = row.style.display === 'none' || !row.style.display;
                row.style.display = isHidden ? 'table-row' : 'none';

                // Track expanded state
                if (isHidden) {
                    expandedRequests.add(id);
                } else {
                    expandedRequests.delete(id);
                }
            }
        }

        // Make Alpine data accessible to functions
        let alpineData = null;
        document.addEventListener('alpine:initialized', () => {
            alpineData = Alpine.$data(document.body);
            // Trigger initial data load now that Alpine is ready
            onTabChange(alpineData.currentTab || 'stats');
        });

        let byModelData = [];
        let byProviderData = [];
        let errorsData = [];

        // Provider trends chart state
        let hiddenProviders = new Set();

        // Provider colors (shared with bar chart)
        const PROVIDER_COLORS = {
            'openai': '#10a37f',
            'anthropic': '#d97757',
            'google': '#4285f4',
            'default': '#999999'
        };

        function getProviderColor(provider) {
            return PROVIDER_COLORS[provider] || PROVIDER_COLORS.default;
        }

        async function renderProviderTrends() {
            if (!alpineData) return;

            const container = document.getElementById('provider-trends-chart');
            const query = alpineData.buildQuery(alpineData.statsFilter);

            try {
                // Use same date range as stats filter
                const res = await fetch(`/stats/daily${query}`);
                const data = await res.json();

                if (!data.daily || data.daily.length === 0) {
                    container.innerHTML = '<div class="chart-empty">No data available for selected date range</div>';
                    return;
                }

                // Sort daily data by date ascending for proper line rendering
                const dailyData = data.daily.sort((a, b) => a.date.localeCompare(b.date));

                // Group data by provider
                const providerData = {};
                dailyData.forEach(day => {
                    day.by_provider.forEach(p => {
                        if (!providerData[p.provider]) {
                            providerData[p.provider] = [];
                        }
                        providerData[p.provider].push({
                            date: day.date,
                            cost: p.cost
                        });
                    });
                });

                // Fill in missing dates with 0 cost for each provider
                const allDates = dailyData.map(d => d.date);
                Object.keys(providerData).forEach(provider => {
                    const existingDates = new Set(providerData[provider].map(d => d.date));
                    allDates.forEach(date => {
                        if (!existingDates.has(date)) {
                            providerData[provider].push({ date, cost: 0 });
                        }
                    });
                    // Re-sort after filling gaps
                    providerData[provider].sort((a, b) => a.date.localeCompare(b.date));
                });

                renderChart(container, providerData, allDates);
            } catch (e) {
                console.error('Failed to load provider trends:', e);
                container.innerHTML = '<div class="chart-empty">Failed to load chart data</div>';
            }
        }

        function renderChart(container, providerData, dates) {
            const width = container.offsetWidth - 40; // Account for padding
            const height = 300;
            const margin = { top: 20, right: 80, bottom: 60, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // Calculate scales
            const maxCost = Math.max(...Object.values(providerData).flatMap(d => d.map(p => p.cost)), 0.0001);
            const minCost = 0;

            // X scale: date to pixel
            const xScale = (dateIndex) => (dateIndex / (dates.length - 1 || 1)) * chartWidth;

            // Y scale: cost to pixel (inverted because SVG Y increases downward)
            const yScale = (cost) => chartHeight - ((cost - minCost) / (maxCost - minCost)) * chartHeight;

            // Format date for display
            const formatDate = (dateStr) => {
                const date = new Date(dateStr);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            };

            // Create SVG
            let svg = `
                <svg class="chart-svg" viewBox="0 0 ${width} ${height + 40}" xmlns="http://www.w3.org/2000/svg">
                    <g transform="translate(${margin.left}, ${margin.top})">
            `;

            // Add grid lines
            const gridSteps = 5;
            for (let i = 0; i <= gridSteps; i++) {
                const y = (i / gridSteps) * chartHeight;
                svg += `<line class="chart-grid" x1="0" y1="${y}" x2="${chartWidth}" y2="${y}" />`;
            }

            // Add Y axis
            svg += `<line class="chart-axis" x1="0" y1="0" x2="0" y2="${chartHeight}" />`;
            for (let i = 0; i <= gridSteps; i++) {
                const y = (i / gridSteps) * chartHeight;
                const cost = maxCost - (i / gridSteps) * (maxCost - minCost);
                svg += `<text class="chart-axis-text" x="-10" y="${y + 4}" text-anchor="end">$${cost.toFixed(3)}</text>`;
            }

            // Add X axis
            svg += `<line class="chart-axis" x1="0" y1="${chartHeight}" x2="${chartWidth}" y2="${chartHeight}" />`;

            // Add X axis labels (show fewer labels to avoid crowding)
            const labelStep = Math.ceil(dates.length / 8);
            dates.forEach((date, i) => {
                if (i % labelStep === 0 || i === dates.length - 1) {
                    const x = xScale(i);
                    svg += `<text class="chart-axis-text" x="${x}" y="${chartHeight + 20}" text-anchor="middle">${formatDate(date)}</text>`;
                }
            });

            // Draw lines for each provider
            Object.entries(providerData).forEach(([provider, data]) => {
                const color = getProviderColor(provider);
                const isHidden = hiddenProviders.has(provider);

                if (isHidden) return;

                // Generate path
                const pathData = data.map((d, i) => {
                    const x = xScale(i);
                    const y = yScale(d.cost);
                    return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
                }).join(' ');

                svg += `<path class="chart-line" d="${pathData}" stroke="${color}" />`;

                // Add dots
                data.forEach((d, i) => {
                    if (d.cost > 0) {
                        const x = xScale(i);
                        const y = yScale(d.cost);
                        svg += `
                            <circle class="chart-dot" cx="${x}" cy="${y}" r="3" stroke="${color}"
                                    onmouseover="showChartTooltip(event, '${d.date}', '${provider}', ${d.cost})"
                                    onmouseout="hideChartTooltip()" />
                        `;
                    }
                });
            });

            svg += `
                    </g>
                </svg>
            `;

            // Add legend
            const legend = Object.keys(providerData).map(provider => {
                const color = getProviderColor(provider);
                const isHidden = hiddenProviders.has(provider);
                const totalCost = providerData[provider].reduce((sum, d) => sum + d.cost, 0);

                return `
                    <div class="chart-legend-item ${isHidden ? 'inactive' : ''}" onclick="toggleProvider('${provider}')">
                        <div class="chart-legend-color" style="background: ${color}"></div>
                        <div class="chart-legend-label">${provider} ($${totalCost.toFixed(4)})</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = svg + `<div class="chart-legend">${legend}</div>`;
        }

        function showChartTooltip(event, date, provider, cost) {
            const tooltip = document.getElementById('chart-tooltip');
            tooltip.innerHTML = `
                <div class="chart-tooltip-date">${date}</div>
                <div class="chart-tooltip-item">
                    <span>${provider}:</span>
                    <span>$${cost.toFixed(4)}</span>
                </div>
            `;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 30) + 'px';
        }

        function hideChartTooltip() {
            const tooltip = document.getElementById('chart-tooltip');
            tooltip.style.display = 'none';
        }

        function toggleProvider(provider) {
            if (hiddenProviders.has(provider)) {
                hiddenProviders.delete(provider);
            } else {
                hiddenProviders.add(provider);
            }
            renderProviderTrends();
        }

        async function refreshStats() {
            if (!alpineData) return;
            const query = alpineData.buildQuery(alpineData.statsFilter);

            // Fetch stats and daily data in parallel for faster loading
            const [statsRes, _] = await Promise.all([
                fetch(`/stats${query}`),
                renderProviderTrends() // Start chart fetch in parallel
            ]);
            const data = await statsRes.json();

            // Totals
            document.getElementById('totals').innerHTML = `
                <div class="metric">
                    <div class="metric-value">${data.totals.requests}</div>
                    <div class="metric-label">REQUESTS</div>
                </div>
                <div class="metric">
                    <div class="metric-value">$${data.totals.cost.toFixed(4)}</div>
                    <div class="metric-label">TOTAL COST</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${(data.totals.prompt_tokens + data.totals.completion_tokens).toLocaleString()}</div>
                    <div class="metric-label">TOTAL TOKENS</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${data.totals.avg_duration_ms.toFixed(0)}ms</div>
                    <div class="metric-label">AVG DURATION</div>
                </div>
            `;

            // Provider breakdown visualization
            const totalCost = data.totals.cost;

            let providerHtml = '';
            if (data.by_provider.length > 0 && totalCost > 0) {
                providerHtml = data.by_provider.map(p => {
                    const percentage = (p.cost / totalCost * 100);
                    const color = getProviderColor(p.provider);

                    return `
                        <div class="provider-bar">
                            <div class="provider-header">
                                <span class="provider-name">${p.provider}</span>
                                <span class="provider-percentage">${percentage.toFixed(0)}%</span>
                            </div>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                            </div>
                            <div class="provider-details">
                                $${p.cost.toFixed(4)} across ${p.requests} requests ($${(p.cost / p.requests).toFixed(4)} per request)
                            </div>
                        </div>
                    `;
                }).join('');

                providerHtml += `<div style="margin-top: 20px; font-weight: bold;">Total: $${totalCost.toFixed(4)} (${data.totals.requests} requests)</div>`;
            } else {
                providerHtml = '<div style="color: #666;">No data available</div>';
            }

            document.getElementById('provider-breakdown').innerHTML = providerHtml;

            // By model - convert to sortable format
            byModelData = data.by_model.map(m => [m.model, m.requests, m.cost, m.tokens]);
            if (!tableSortState['by-model']) {
                tableSortState['by-model'] = { column: null, direction: null, originalData: [...byModelData] };
            } else {
                tableSortState['by-model'].originalData = [...byModelData];
            }
            renderByModelTable(applySortIfNeeded('by-model', byModelData), tableSortState['by-model']);

            // By provider - convert to sortable format
            byProviderData = data.by_provider.map(p => [p.provider, p.requests, p.cost, p.tokens]);
            if (!tableSortState['by-provider']) {
                tableSortState['by-provider'] = { column: null, direction: null, originalData: [...byProviderData] };
            } else {
                tableSortState['by-provider'].originalData = [...byProviderData];
            }
            renderByProviderTable(applySortIfNeeded('by-provider', byProviderData), tableSortState['by-provider']);

            // Errors - convert to sortable format
            errorsData = data.recent_errors.map(e => [new Date(e.timestamp + 'Z').getTime(), e.model, e.error, e.timestamp]);
            if (!tableSortState['errors']) {
                tableSortState['errors'] = { column: null, direction: null, originalData: [...errorsData] };
            } else {
                tableSortState['errors'].originalData = [...errorsData];
            }
            renderErrorsTable(applySortIfNeeded('errors', errorsData), tableSortState['errors']);
        }

        function sortByModelTable(columnIndex) {
            sortTable('by-model', columnIndex, byModelData, renderByModelTable);
        }

        function renderByModelTable(data, sortState) {
            const table = document.getElementById('by-model');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortByModelTable(0)">Model</th>
                        <th class="sortable" onclick="sortByModelTable(1)">Requests</th>
                        <th class="sortable" onclick="sortByModelTable(2)">Cost</th>
                        <th class="sortable" onclick="sortByModelTable(3)">Tokens</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>$${row[2].toFixed(4)}</td>
                            <td>${row[3].toLocaleString()}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        function sortByProviderTable(columnIndex) {
            sortTable('by-provider', columnIndex, byProviderData, renderByProviderTable);
        }

        function renderByProviderTable(data, sortState) {
            const table = document.getElementById('by-provider');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortByProviderTable(0)">Provider</th>
                        <th class="sortable" onclick="sortByProviderTable(1)">Requests</th>
                        <th class="sortable" onclick="sortByProviderTable(2)">Cost</th>
                        <th class="sortable" onclick="sortByProviderTable(3)">Tokens</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>$${row[2].toFixed(4)}</td>
                            <td>${row[3].toLocaleString()}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        function sortErrorsTable(columnIndex) {
            sortTable('errors', columnIndex, errorsData, renderErrorsTable);
        }

        function renderErrorsTable(data, sortState) {
            const table = document.getElementById('errors');
            if (data.length === 0) {
                table.innerHTML = '<tr><td>No errors</td></tr>';
                return;
            }

            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortErrorsTable(0)">Time</th>
                        <th class="sortable" onclick="sortErrorsTable(1)">Model</th>
                        <th class="sortable" onclick="sortErrorsTable(2)">Error</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${new Date(row[3] + 'Z').toLocaleString()}</td>
                            <td>${row[1]}</td>
                            <td class="error">${row[2]}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            updateSortIndicators(table, sortState);
        }

        async function clearErrors() {
            if (!confirm('Clear all errors from the database?')) return;
            await fetch('/errors', { method: 'DELETE' });
            refreshStats();
        }

        // Calendar functionality
        let currentMonth = new Date();
        let selectedDate = null;
        let calendarData = {};

        function getCostColor(cost, maxCost) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

            if (cost === 0) {
                return isDark ? '#2a2a2a' : '#f0f0f0';
            }

            const ratio = Math.min(cost / (maxCost || 1), 1);

            if (isDark) {
                // Dark mode: darker blues with less saturation
                const lightness = 25 + (ratio * 25); // 25% to 50%
                const saturation = 60 + (ratio * 20); // 60% to 80%
                return `hsl(210, ${saturation}%, ${lightness}%)`;
            } else {
                // Light mode: lighter blues
                const lightness = 100 - (ratio * 50); // 100% to 50%
                return `hsl(210, 100%, ${lightness}%)`;
            }
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function loadCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const startDate = formatDate(firstDay);
            const endDate = formatDate(lastDay);

            // Get browser timezone offset in minutes from UTC (negative for west)
            const timezoneOffset = -new Date().getTimezoneOffset();

            const res = await fetch(`/stats/daily?start_date=${startDate}&end_date=${endDate}&timezone_offset=${timezoneOffset}`);
            const data = await res.json();

            calendarData = {};
            data.daily.forEach(day => {
                calendarData[day.date] = day;
            });

            renderCalendar(year, month);
        }

        function renderCalendar(year, month) {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('current-month').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startingDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const today = formatDate(new Date());
            const maxCost = Math.max(...Object.values(calendarData).map(d => d.cost), 0.01);

            let html = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div class="calendar-day-header">${day}</div>`;
            });

            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = formatDate(new Date(year, month, day));
                const dayData = calendarData[date] || { requests: 0, cost: 0 };
                const bgColor = getCostColor(dayData.cost, maxCost);
                const isToday = date === today ? 'today' : '';

                const ariaLabel = `${date}: ${dayData.requests} requests, $${dayData.cost.toFixed(2)} total cost`;
                html += `
                    <div class="calendar-day ${isToday}"
                         style="background-color: ${bgColor}"
                         onclick="onDayClick('${date}')"
                         onkeydown="handleCalendarKeyPress(event, '${date}')"
                         tabindex="0"
                         role="gridcell"
                         aria-label="${ariaLabel}"
                         data-date="${date}">
                        <div class="day-number">${day}</div>
                        <div class="day-cost">$${dayData.cost.toFixed(2)}</div>
                        <div class="day-requests">${dayData.requests} req</div>
                    </div>
                `;
            }

            document.getElementById('calendar-grid').innerHTML = html;
        }

        function navigateMonth(direction) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
            loadCalendar();
        }

        function handleCalendarKeyPress(event, date) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                onDayClick(date);
            }
        }

        function onDayClick(date) {
            selectedDate = date;
            const dayData = calendarData[date];

            if (!dayData || dayData.requests === 0) {
                document.getElementById('day-detail').style.display = 'none';
                return;
            }

            const detailTitle = document.getElementById('day-detail-title');
            const detailContent = document.getElementById('day-detail-content');

            detailTitle.textContent = `${date} - $${dayData.cost.toFixed(4)} across ${dayData.requests} requests`;

            let providersHtml = '<h4>By Provider:</h4>';
            const totalCost = dayData.cost;

            dayData.by_provider.forEach(p => {
                const percentage = totalCost > 0 ? (p.cost / totalCost * 100) : 0;
                const color = getProviderColor(p.provider);

                providersHtml += `
                    <div class="provider-bar">
                        <div class="provider-header">
                            <span class="provider-name">${p.provider}</span>
                            <span class="provider-percentage">${percentage.toFixed(0)}%</span>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                        </div>
                        <div class="provider-details">
                            $${p.cost.toFixed(4)} across ${p.requests} requests
                        </div>
                    </div>
                `;
            });

            detailContent.innerHTML = providersHtml;
            document.getElementById('day-detail').style.display = 'block';
        }

        // Auto-refresh stats every 5 seconds (uses current filter state)
        setInterval(() => {
            if (alpineData && alpineData.currentTab === 'stats') {
                refreshStats();
            }
        }, 5000);

        // Load initial tab data after Alpine initializes
        document.addEventListener('alpine:initialized', () => {
            const initialTab = localStorage.getItem('_x_currentTab')?.replace(/['"]/g, '') || 'stats';
            onTabChange(initialTab);
        });
    </script>
</body>
</html>
